<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="pageTitle">–ú–∞—Ä—à—Ä—É—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞ v3.6</title>
    <style>
        :root {
            --bg: #f4f7f9; --card: #ffffff; --ink: #2c3e50; --muted: #7f8c8d; --accent: #27ae60;
            --danger: #e74c3c; --warn: #f39c12; --line: #dfe4ea; --header-bg: #ecf0f1;
            --primary-btn-bg: #3498db; --primary-btn-border: #2980b9;
        }
        html, body { height: 100%; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg); color: var(--ink); margin: 0; line-height: 1.5; font-size: 14px;
        }
        .app { max-width: 1600px; margin: 24px auto; padding: 0 16px 64px; }
        h1 { font-size: 1.8rem; margin: 0 0 12px; color: #34495e; }
        h2 { font-size: 1.2rem; margin: 24px 0 12px; color: #34495e; border-bottom: 2px solid var(--header-bg); padding-bottom: 8px; }
        .toolbar { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; justify-content: space-between; margin-bottom: 16px; }
        .toolbar .left, .toolbar .right { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
        .card { background: var(--card); border: 1px solid var(--line); border-radius: 12px; padding: 16px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05); margin-bottom: 16px; }
        label { font-size: .9rem; color: var(--muted); font-weight: 600; margin-bottom: 4px; display: block; }
        input, select, textarea, button {
            background: #fff; color: var(--ink); border: 1px solid var(--line); border-radius: 8px; padding: 9px 12px; font-size: .95rem; width: 100%; box-sizing: border-box;
        }
        input:focus, select:focus, textarea:focus { outline: 2px solid #3498db; border-color: transparent; }
        textarea { resize: none; overflow-y: hidden; min-height: 40px; }
        .grid { display: grid; gap: 16px; }
        .meta-grid { grid-template-columns: repeat(6, 1fr); }
        .meta-grid .grid-span-2 { grid-column: span 2; }
        .meta-grid .grid-span-3 { grid-column: span 3; }
        @media (max-width: 900px) { .meta-grid .grid-span-2, .meta-grid .grid-span-3 { grid-column: span 6; } }
        @media (max-width: 1200px) and (min-width: 901px) { .meta-grid .grid-span-3 { grid-column: span 6; } }

        .ok { color: var(--accent); } .bad { color: var(--danger); }
        .btn { cursor: pointer; transition: all .1s ease; user-select: none; border: none; color: #fff; width: auto; }
        .btn:hover { opacity: 0.9; } .btn:active { transform: scale(0.98); }
        .btn.primary { background: var(--primary-btn-bg); } .btn.secondary { background: #95a5a6; } .btn.danger { background: var(--danger); }
        .btn.small { padding: 5px 10px; font-size: .85rem; border-radius: 6px; }
        .lang-btn { background: #fff; color: var(--ink); padding: 6px 12px; font-size: 1.2rem; line-height: 1; }
        .lang-btn.active { outline: 2px solid var(--primary-btn-bg); box-shadow: 0 0 5px rgba(52, 152, 219, 0.5); }

        .row-actions { display: flex; gap: 6px; align-items: center; justify-content: center; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid var(--line); padding: 8px; vertical-align: top; text-align: left; }
        th { background: var(--header-bg); font-weight: 600; color: #34495e; white-space: nowrap; }
        .phase-header td { background: #3498db; color: white; font-weight: bold; }
        .step-header td { background: var(--header-bg); font-weight: bold; }
        .kpi { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
        .kpi .box { background: var(--header-bg); border: 1px solid var(--line); padding: 8px 12px; border-radius: 8px; }
        .spacer { flex: 1; }
        .section-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 12px; }
        .footnote { font-size: .85rem; color: var(--muted); text-align: center; margin-top: 20px; }
        input[type="number"] { text-align: right; }
        .text-center { text-align: center; }
        .print-only { display: none; }
        .fill-in { min-height: 1.3em; }
        .print-content { display: none; }

        @media print {
            body { background: #fff; color: #000; font-size: 12px; line-height: 1.3; }
            .app { max-width: 100%; margin: 0; padding: 10px; box-shadow: none; }
            .card { box-shadow: none; border: 1px solid #ccc; page-break-inside: avoid; padding: 10px; border-radius: 0; }
            .toolbar, .section-actions, .row-actions, .no-print { display: none !important; }
            h1, h2 { font-size: 1.2rem; color: #000; page-break-after: avoid; margin: 12px 0 8px; padding-bottom: 4px; border-color: #ccc; }
            h1 { font-size: 1.5rem; text-align: center; }
            textarea { display: none !important; }
            input, select { border: none; padding: 0; background: transparent; color: #000; -webkit-print-color-adjust: exact; width: 100%; font-size: inherit; font-family: inherit; box-shadow: none; outline: none; }
            .print-content { display: block !important; white-space: pre-wrap; word-break: break-word; font-family: inherit; font-size: inherit; }
            table { page-break-inside: auto; table-layout: fixed; }
            tr { page-break-inside: avoid; page-break-after: auto; }
            th, td { padding: 4px; border: 1px solid #aaa; vertical-align: middle; word-wrap: break-word; }
            th, .phase-header td { background-color: #e0e0e0 !important; color: #000 !important; -webkit-print-color-adjust: exact; }
            .print-only { display: table-cell !important; }
            .fill-in { border-bottom: none; }

            .card .meta-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0 16px; padding: 0; }
            .card .meta-grid > div { grid-column: auto !important; display: flex; align-items: baseline; border-bottom: 1px dotted #ccc; padding: 2px 0; }
            .card .meta-grid label { font-weight: 600; margin-right: 6px; padding: 0; color: #000; }
            .card .meta-grid label::after { content: ":"; }

            /* –ò–ó–ú–ï–ù–ï–ù–ò–ï: –°–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —à–∏—Ä–∏–Ω–∞ –∫–æ–ª–æ–Ω–æ–∫ –†–µ—Ü–µ–ø—Ç—É—Ä—ã –¥–ª—è –ø–µ—á–∞—Ç–∏, —á—Ç–æ–±—ã –∑–∞–ø–æ–ª–Ω–∏—Ç—å –≤—Å—é —Å—Ç—Ä–∞–Ω–∏—Ü—É */
            #formTable th:nth-of-type(1), #formTable td:nth-of-type(1) { width: 5%; }   /* –§–∞–∑–∞ */
            #formTable th:nth-of-type(2), #formTable td:nth-of-type(2) { width: 51%; }  /* –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ */
            #formTable th:nth-of-type(3), #formTable td:nth-of-type(3) { width: 17%; }  /* –ê–Ω–∞–ª–∏—Ç. –ª–∏—Å—Ç */
            #formTable th:nth-of-type(4), #formTable td:nth-of-type(4) { width: 7%; }   /* % */
            #formTable th:nth-of-type(5), #formTable td:nth-of-type(5) { width: 10%; }  /* –ó–∞–≥—Ä—É–∑–∫–∞, –∫–≥ */
            #formTable th:nth-of-type(6), #formTable td:nth-of-type(6) { width: 10%; }  /* –§–∞–∫—Ç, –∫–≥ */

            #procTable colgroup, #procTable col { display: none; }
            #procTable th:nth-of-type(1), #procTable td:nth-of-type(1) { width: 5%; }
            #procTable th:nth-of-type(2), #procTable td:nth-of-type(2) { width: 30%; }
            #procTable th:nth-of-type(3), #procTable td:nth-of-type(3) { width: 18%; }
            #procTable th:nth-of-type(4), #procTable td:nth-of-type(4) { width: 25%; }
            #procTable th:nth-of-type(5), #procTable td:nth-of-type(5) { width: 10%; }
            #procTable .print-only { width: 12%; }

            .qc-block table th:nth-of-type(1), .qc-block table td:nth-of-type(1) { width: 40%; }
            .qc-block table th:nth-of-type(2), .qc-block table td:nth-of-type(2) { width: 40%; word-break: break-word; }
            .qc-block table th:nth-of-type(3), .qc-block table td:nth-of-type(3) { width: 20%; }
        }
    </style>
</head>
<body>
<div class="app">
    <!-- TOOLBAR -->
    <div class="toolbar card no-print">
        <div class="left"><h1 data-i18n="title">–ú–∞—Ä—à—Ä—É—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞</h1></div>
        <div class="right">
            <div class="lang-switcher" style="display: flex; gap: 5px;">
                <button class="btn lang-btn" id="langRuBtn" title="–†—É—Å—Å–∫–∏–π">üá∑üá∫</button>
                <button class="btn lang-btn" id="langEnBtn" title="English">üá¨üáß</button>
            </div>
            <button class="btn primary" id="printBtn" data-i18n="print">üñ®Ô∏è –ü–µ—á–∞—Ç—å / PDF</button>
            <button class="btn secondary" id="saveBtn" data-i18n="save">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å JSON</button>
            <label class="btn secondary" for="loadInput" data-i18n="load">üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç—å JSON</label>
            <input type="file" id="loadInput" class="no-print" accept=".json" style="display:none" />
            <button class="btn danger" id="clearBtn" data-i18n="clear">‚ùå –û—á–∏—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º—É</button>
        </div>
    </div>

    <!-- META INFO -->
    <div class="card">
        <h2 data-i18n="meta">–ö–∞—Ä—Ç–æ—á–∫–∞ –∏–∑–¥–µ–ª–∏—è</h2>
        <div class="grid meta-grid">
            <div class="grid-span-3"><label data-i18n="productName">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞</label><input id="productName" /></div>
            <div class="grid-span-2"><label data-i18n="productCode">–ö–æ–¥ / –ê—Ä—Ç–∏–∫—É–ª</label><input id="productCode" /></div>
            <div><label data-i18n="version">–í–µ—Ä—Å–∏—è</label><input id="docVersion" value="1.0" /></div>
            <div class="grid-span-3"><label data-i18n="author">–¢–µ—Ö–Ω–æ–ª–æ–≥</label><input id="author" /></div>
            <div class="grid-span-2"><label data-i18n="date">–î–∞—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞</label><input id="docDate" type="date" /></div>
            <div><label data-i18n="batchSize">–†–∞–∑–º–µ—Ä –ø–∞—Ä—Ç–∏–∏ (–∫–≥)</label><input id="batchSize" type="number" min="0" step="0.01" value="100" /></div>
        </div>
    </div>

    <!-- FORMULATION TABLE -->
    <div class="card">
        <div class="kpi">
            <h2 data-i18n="formulation">–†–µ—Ü–µ–ø—Ç—É—Ä–∞</h2>
            <span class="spacer"></span>
            <div class="box"><span class="muted" data-i18n="totalPercent">–°—É–º–º–∞ %:</span> <strong id="sumPercent">0.00%</strong></div>
        </div>
        <table id="formTable">
            <thead><tr>
                <th style="width:5%" data-i18n="phase">–§–∞–∑–∞</th>
                <th style="width:35%" data-i18n="trade">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
                <th style="width:10%" data-i18n="analysisSheet">–ê–Ω–∞–ª–∏—Ç. –ª–∏—Å—Ç</th>
                <th style="width:6%" data-i18n="percent">%</th>
                <th style="width:10%" data-i18n="mass">–ó–∞–≥—Ä—É–∑–∫–∞, –∫–≥</th>
                <th style="width:10%" class="no-print" data-i18n="actions">–î–µ–π—Å—Ç–≤–∏—è</th>
                <th class="print-only" data-i18n="actualMass">–§–∞–∫—Ç, –∫–≥</th>
            </tr></thead>
            <tbody id="formBody"></tbody>
        </table>
        <div class="section-actions no-print"><button class="btn primary small" id="addIngredientBtn" data-i18n="addIngredient">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç</button></div>
    </div>

    <!-- PROCESS TABLE -->
    <div class="card">
        <h2 data-i18n="process">–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø—Ä–æ—Ü–µ—Å—Å</h2>
        <table id="procTable">
            <thead><tr>
                <th style="width:5%" data-i18n="step">‚Ññ</th>
                <th style="width:30%" data-i18n="description">–û–ø–∏—Å–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏</th>
                <th style="width:20%" data-i18n="equipment">–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</th>
                <th style="width:20%" data-i18n="paramName">–ü–∞—Ä–∞–º–µ—Ç—Ä –ø—Ä–æ—Ü–µ—Å—Å–∞</th>
                <th style="width:10%" data-i18n="norm">–ù–æ—Ä–º–∞</th>
                <th style="width:15%" class="no-print" data-i18n="actions">–î–µ–π—Å—Ç–≤–∏—è</th>
                <th class="print-only" data-i18n="actual">–§–∞–∫—Ç</th>
            </tr></thead>
            <tbody id="procBody"></tbody>
        </table>
        <div class="section-actions no-print"><button class="btn primary small" id="addProcBtn" data-i18n="addStep">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å—Ç–∞–¥–∏—é</button></div>
    </div>

    <!-- QC TABLE -->
    <div class="card">
        <h2 data-i18n="qc">–ö–æ–Ω—Ç—Ä–æ–ª—å –∫–∞—á–µ—Å—Ç–≤–∞ (–û–ö–ö)</h2>
        <div id="qcContainer"></div>
        <div class="section-actions no-print"><button class="btn primary small" id="addQcBtn" data-i18n="addQc">‚ûï –î–æ–±–∞–≤–∏—Ç—å –±–ª–æ–∫ –∫–æ–Ω—Ç—Ä–æ–ª—è</button></div>
    </div>
    
    <div class="footnote no-print"><span data-i18n="foot">–ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ.</span></div>
</div>

<!-- TEMPLATES -->
<template id="ingredientRowTpl">
    <tr>
        <td class="text-center"><input class="data-field text-center" data-key="phase" data-i18n-placeholder="phasePlaceholder" maxlength="5"></td>
        <td>
            <textarea class="data-field" data-key="tradeName" data-i18n-placeholder="tradeNamePlaceholder" rows="1"></textarea>
            <div class="print-content" data-key="tradeName-print"></div>
        </td>
        <td><input class="data-field" data-key="analysisSheet" placeholder=""></td>
        <td class="text-center"><input class="data-field text-center" data-key="percent" type="number" min="0" max="100" step="0.01" value="0"></td>
        <td class="mass-cell" style="text-align: right;">0.000</td>
        <td class="no-print row-actions"><button class="btn danger small delBtn" data-i18n="del">–£–¥–∞–ª–∏—Ç—å</button></td>
        <td class="print-only"><div class="fill-in"></div></td>
    </tr>
</template>

<template id="procStepRowTpl">
    <tr class="step-header">
        <td class="step-number" style="text-align: center; vertical-align: middle;"></td>
        <td class="step-description" style="vertical-align: middle;">
            <textarea class="data-field" data-key="description" rows="2"></textarea>
            <div class="print-content" data-key="description-print"></div>
        </td>
        <td class="step-equipment" style="vertical-align: middle;">
            <textarea class="data-field" data-key="equipment" rows="2"></textarea>
            <div class="print-content" data-key="equipment-print"></div>
        </td>
    </tr>
</template>

<template id="procParamRowTpl">
    <tr class="param-row">
        <td><input class="data-field" data-key="name" data-i18n-placeholder="paramNamePlaceholder"></td>
        <td><input class="data-field" data-key="norm" data-i18n-placeholder="normPlaceholder"></td>
        <td class="no-print row-actions"><button class="btn danger small delParamBtn" data-i18n="del">X</button></td>
        <td class="print-only"><div class="fill-in"></div></td>
    </tr>
</template>

<template id="qcBlockTpl">
    <div class="qc-block" style="margin-bottom: 20px;">
        <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
            <input class="data-field" data-key="name" data-i18n-placeholder="qcBlockNamePlaceholder" style="font-weight:bold; font-size:1.1rem; border:none; border-bottom:1px solid #ccc; flex:1;">
            <button class="btn danger small delQcBtn no-print" data-i18n="delBlock">–£–¥–∞–ª–∏—Ç—å –±–ª–æ–∫</button>
        </div>
        <table>
            <thead><tr>
                <th data-i18n="qcParamName">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è</th>
                <th data-i18n="qcStandard">–ù–æ—Ä–º–∞—Ç–∏–≤</th>
                <th data-i18n="qcResult">–†–µ–∑—É–ª—å—Ç–∞—Ç</th>
                <th class="no-print" data-i18n="actions">–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr></thead>
            <tbody></tbody>
        </table>
        <div class="section-actions no-print">
            <button class="btn primary small addQcCheckBtn" data-i18n="addQcCheck">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É</button>
        </div>
    </div>
</template>

<template id="qcCheckRowTpl">
    <tr>
        <td><input class="data-field" data-key="parameter" data-i18n-placeholder="qcParamPlaceholder"></td>
        <td><input class="data-field" data-key="standard" data-i18n-placeholder="qcStandardPlaceholder"></td>
        <td><div class="fill-in"></div></td>
        <td class="no-print row-actions"><button class="btn danger small delQcCheckBtn" data-i18n="del">X</button></td>
    </tr>
</template>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    const STORAGE_KEY = "routing_map_draft_v3.6";
    const LANG_KEY = "routing_map_lang";

    // --- I18N - INTERNATIONALIZATION ---
    const translations = {
        ru: {
            pageTitle: "–ú–∞—Ä—à—Ä—É—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞ v3.6",
            title: "–ú–∞—Ä—à—Ä—É—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞",
            print: "üñ®Ô∏è –ü–µ—á–∞—Ç—å / PDF",
            save: "üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å JSON",
            load: "üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç—å JSON",
            clear: "‚ùå –û—á–∏—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º—É",
            meta: "–ö–∞—Ä—Ç–æ—á–∫–∞ –∏–∑–¥–µ–ª–∏—è",
            productName: "–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞",
            productCode: "–ö–æ–¥ / –ê—Ä—Ç–∏–∫—É–ª",
            version: "–í–µ—Ä—Å–∏—è",
            date: "–î–∞—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞",
            author: "–¢–µ—Ö–Ω–æ–ª–æ–≥",
            batchSize: "–†–∞–∑–º–µ—Ä –ø–∞—Ä—Ç–∏–∏ (–∫–≥)",
            formulation: "–†–µ—Ü–µ–ø—Ç—É—Ä–∞",
            totalPercent: "–°—É–º–º–∞ %:",
            phase: "–§–∞–∑–∞",
            trade: "–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ",
            analysisSheet: "–ê–Ω–∞–ª–∏—Ç. –ª–∏—Å—Ç",
            percent: "%",
            mass: "–ó–∞–≥—Ä—É–∑–∫–∞, –∫–≥",
            actions: "–î–µ–π—Å—Ç–≤–∏—è",
            actualMass: "–§–∞–∫—Ç, –∫–≥",
            addIngredient: "‚ûï –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç",
            process: "–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø—Ä–æ—Ü–µ—Å—Å",
            step: "‚Ññ",
            description: "–û–ø–∏—Å–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏",
            equipment: "–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ",
            paramName: "–ü–∞—Ä–∞–º–µ—Ç—Ä –ø—Ä–æ—Ü–µ—Å—Å–∞",
            norm: "–ù–æ—Ä–º–∞",
            actual: "–§–∞–∫—Ç",
            addStep: "‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å—Ç–∞–¥–∏—é",
            qc: "–ö–æ–Ω—Ç—Ä–æ–ª—å –∫–∞—á–µ—Å—Ç–≤–∞ (–û–ö–ö)",
            addQc: "‚ûï –î–æ–±–∞–≤–∏—Ç—å –±–ª–æ–∫ –∫–æ–Ω—Ç—Ä–æ–ª—è",
            foot: "–ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ.",
            del: "–£–¥–∞–ª–∏—Ç—å",
            delBlock: "–£–¥–∞–ª–∏—Ç—å –±–ª–æ–∫",
            addParam: "‚ûï –ü–∞—Ä–∞–º–µ—Ç—Ä",
            addQcCheck: "‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É",
            phaseHeader: "–§–∞–∑–∞",
            dataLoaded: "–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã!",
            fileReadError: "–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞: ",
            confirmDelete: "–í—ã —É–≤–µ—Ä–µ–Ω—ã?",
            confirmClear: "–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º—É? –í—Å–µ –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã.",
            confirmDeleteBlock: "–£–¥–∞–ª–∏—Ç—å –≤–µ—Å—å –±–ª–æ–∫ –∫–æ–Ω—Ç—Ä–æ–ª—è?",
            phasePlaceholder: "A",
            tradeNamePlaceholder: "–í–æ–¥–∞ –æ—á–∏—â–µ–Ω–Ω–∞—è",
            paramNamePlaceholder: "–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞, ¬∞C",
            normPlaceholder: "75-80",
            qcBlockNamePlaceholder: "–ö–æ–Ω—Ç—Ä–æ–ª—å-1 –Ω–∞ —Å—Ç–∞–¥–∏–∏ X",
            qcParamName: "–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è",
            qcStandard: "–ù–æ—Ä–º–∞—Ç–∏–≤",
            qcResult: "–†–µ–∑—É–ª—å—Ç–∞—Ç",
            qcParamPlaceholder: "–í–Ω–µ—à–Ω–∏–π –≤–∏–¥",
            qcStandardPlaceholder: "–û–¥–Ω–æ—Ä–æ–¥–Ω–∞—è –º–∞—Å—Å–∞",
        },
        en: {
            pageTitle: "Manufacturing Route Card v3.6",
            title: "Manufacturing Route Card",
            print: "üñ®Ô∏è Print / PDF",
            save: "üíæ Save JSON",
            load: "üìÅ Load JSON",
            clear: "‚ùå Clear Form",
            meta: "Product Information",
            productName: "Product Name",
            productCode: "Code / SKU",
            version: "Version",
            date: "Document Date",
            author: "Technologist",
            batchSize: "Batch Size (kg)",
            formulation: "Formulation",
            totalPercent: "Total %:",
            phase: "Phase",
            trade: "Trade Name",
            analysisSheet: "Analysis Sheet",
            percent: "%",
            mass: "Load, kg",
            actions: "Actions",
            actualMass: "Actual, kg",
            addIngredient: "‚ûï Add Ingredient",
            process: "Technological Process",
            step: "#",
            description: "Operation Description",
            equipment: "Equipment",
            paramName: "Process Parameter",
            norm: "Standard",
            actual: "Actual",
            addStep: "‚ûï Add Step",
            qc: "Quality Control (QC)",
            addQc: "‚ûï Add QC Block",
            foot: "Autosave is enabled.",
            del: "Delete",
            delBlock: "Delete block",
            addParam: "‚ûï Parameter",
            addQcCheck: "‚ûï Add Check",
            phaseHeader: "Phase",
            dataLoaded: "Data loaded successfully!",
            fileReadError: "File read error: ",
            confirmDelete: "Are you sure?",
            confirmClear: "Are you sure you want to clear the entire form? All unsaved data will be lost.",
            confirmDeleteBlock: "Delete the entire control block?",
            phasePlaceholder: "A",
            tradeNamePlaceholder: "Purified water",
            paramNamePlaceholder: "Temperature, ¬∞C",
            normPlaceholder: "75-80",
            qcBlockNamePlaceholder: "QC-1 at stage X",
            qcParamName: "Parameter Name",
            qcStandard: "Standard",
            qcResult: "Result",
            qcParamPlaceholder: "Appearance",
            qcStandardPlaceholder: "Homogeneous mass",
        }
    };
    let currentLang = localStorage.getItem(LANG_KEY) || 'ru';

    const i18n = (key) => translations[currentLang][key] || key;

    const setLanguage = (lang) => {
        currentLang = lang;
        localStorage.setItem(LANG_KEY, lang);
        document.documentElement.lang = lang;
        
        $('#langRuBtn').classList.toggle('active', lang === 'ru');
        $('#langEnBtn').classList.toggle('active', lang === 'en');

        $$('[data-i18n]').forEach(el => {
            const key = el.dataset.i18n;
            el.textContent = i18n(key);
        });
        $$('[data-i18n-placeholder]').forEach(el => {
            const key = el.dataset.i18nPlaceholder;
            el.placeholder = i18n(key);
        });
        renderAll();
    };

    // --- HELPER FUNCTIONS ---
    const generateId = () => crypto.randomUUID?.() || String(Date.now() + Math.random());
    const debounce = (func, wait) => {
        let timeout;
        return function executedFunction(...args) {
            const later = () => { clearTimeout(timeout); func.apply(this, args); };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    };
    
    const autoExpand = (textarea) => {
        textarea.style.height = 'auto';
        textarea.style.height = textarea.scrollHeight + 'px';
    };

    const getInitialState = () => ({
        meta: { productName: '', productCode: '', docVersion: '1.0', docDate: new Date().toISOString().slice(0,10), author: '', batchSize: 100 },
        ingredients: [],
        processSteps: [],
        qualityControl: []
    });

    function normalizeState(data) {
        const defaults = getInitialState();
        const normalized = {
            meta: { ...defaults.meta, ...(data.meta || {}) },
            ingredients: Array.isArray(data.ingredients) ? data.ingredients : defaults.ingredients,
            processSteps: Array.isArray(data.processSteps) ? data.processSteps : defaults.processSteps,
            qualityControl: Array.isArray(data.qualityControl) ? data.qualityControl : defaults.qualityControl
        };
        return normalized;
    }

    let state = getInitialState();

    // --- RENDER FUNCTIONS ---
    const renderIngredients = () => {
        const tbody = $('#formBody');
        tbody.innerHTML = '';
        const batchSize = parseFloat(state.meta.batchSize) || 0;
        
        let lastPhase = null;
        state.ingredients.forEach(ing => {
            const currentPhase = (ing.phase || '').toUpperCase();
            if (currentPhase && currentPhase !== lastPhase) {
                const tr = document.createElement('tr');
                tr.className = 'phase-header';
                const td = document.createElement('td');
                td.colSpan = 7;
                td.textContent = `${i18n('phaseHeader')} ${currentPhase}`;
                tr.appendChild(td);
                tbody.appendChild(tr);
                lastPhase = currentPhase;
            }

            const tpl = $('#ingredientRowTpl').content.cloneNode(true);
            const row = tpl.querySelector('tr');
            row.dataset.id = ing.id;
            row.querySelector('[data-key="phase"]').value = ing.phase || '';
            row.querySelector('[data-key="phase"]').placeholder = i18n('phasePlaceholder');
            const tradeNameTextarea = row.querySelector('[data-key="tradeName"]');
            tradeNameTextarea.value = ing.tradeName || '';
            tradeNameTextarea.placeholder = i18n('tradeNamePlaceholder');
            row.querySelector('[data-key="tradeName-print"]').textContent = ing.tradeName || '';
            row.querySelector('[data-key="analysisSheet"]').value = ing.analysisSheet || '';
            row.querySelector('[data-key="percent"]').value = ing.percent || 0;
            row.querySelector('.mass-cell').textContent = (batchSize * (parseFloat(ing.percent) || 0) / 100).toFixed(3);
            row.querySelector('.delBtn').textContent = i18n('del');
            tbody.appendChild(row);
        });
        updateTotals();
    };

    const renderProcess = () => {
        const tbody = $('#procBody');
        tbody.innerHTML = '';
        state.processSteps.forEach(step => {
            const numParams = step.parameters?.length || 0;
            const rowspan = numParams > 0 ? numParams : 1;

            const stepTpl = $('#procStepRowTpl').content.cloneNode(true);
            const stepRow = stepTpl.querySelector('tr');
            stepRow.dataset.id = step.id;

            const numberCell = stepRow.querySelector('.step-number');
            numberCell.setAttribute('rowspan', rowspan);
            const input = document.createElement('input');
            input.className = 'data-field text-center';
            input.dataset.key = 'number';
            input.style.fontWeight = 'bold';
            input.value = step.number || '';
            numberCell.appendChild(input);

            const descCell = stepRow.querySelector('.step-description');
            descCell.querySelector('[data-key="description"]').value = step.description || '';
            descCell.querySelector('[data-key="description-print"]').textContent = step.description || '';
            descCell.setAttribute('rowspan', rowspan);

            const equipCell = stepRow.querySelector('.step-equipment');
            equipCell.querySelector('[data-key="equipment"]').value = step.equipment || '';
            equipCell.querySelector('[data-key="equipment-print"]').textContent = step.equipment || '';
            equipCell.setAttribute('rowspan', rowspan);

            if (numParams > 0) {
                const firstParam = step.parameters[0];
                const paramTpl = $('#procParamRowTpl').content.cloneNode(true);
                const paramCells = Array.from(paramTpl.querySelector('tr').children);
                paramCells[0].querySelector('input').value = firstParam.name || '';
                paramCells[0].querySelector('input').placeholder = i18n('paramNamePlaceholder');
                paramCells[0].querySelector('input').dataset.paramId = firstParam.id;
                paramCells[1].querySelector('input').value = firstParam.norm || '';
                paramCells[1].querySelector('input').placeholder = i18n('normPlaceholder');
                paramCells[1].querySelector('input').dataset.paramId = firstParam.id;
                paramCells[2].querySelector('button').dataset.paramId = firstParam.id;
                paramCells[2].querySelector('button').textContent = 'X';
                
                const actionsTd = paramCells[2]; 
                actionsTd.style.whiteSpace = 'nowrap';

                const addBtn = document.createElement('button');
                addBtn.className = 'btn primary small addParamBtn';
                addBtn.textContent = `‚ûï ${i18n('addParam')}`;
                actionsTd.appendChild(addBtn);

                const delStepBtn = document.createElement('button');
                delStepBtn.className = 'btn danger small delBtn';
                delStepBtn.textContent = i18n('del');
                actionsTd.appendChild(delStepBtn);

                stepRow.append(...paramCells);
                tbody.appendChild(stepRow);

                for (let i = 1; i < numParams; i++) {
                    const param = step.parameters[i];
                    const subsequentParamTpl = $('#procParamRowTpl').content.cloneNode(true);
                    const subsequentParamRow = subsequentParamTpl.querySelector('tr');
                    subsequentParamRow.dataset.id = step.id;
                    subsequentParamRow.querySelector('[data-key="name"]').value = param.name || '';
                    subsequentParamRow.querySelector('[data-key="name"]').placeholder = i18n('paramNamePlaceholder');
                    subsequentParamRow.querySelector('[data-key="name"]').dataset.paramId = param.id;
                    subsequentParamRow.querySelector('[data-key="norm"]').value = param.norm || '';
                    subsequentParamRow.querySelector('[data-key="norm"]').placeholder = i18n('normPlaceholder');
                    subsequentParamRow.querySelector('[data-key="norm"]').dataset.paramId = param.id;
                    const delParamBtn = subsequentParamRow.querySelector('.delParamBtn');
                    delParamBtn.dataset.paramId = param.id;
                    delParamBtn.textContent = 'X';
                    tbody.appendChild(subsequentParamRow);
                }
            } else {
                const emptyCells = `
                    <td></td><td></td>
                    <td class="no-print row-actions">
                        <button class="btn primary small addParamBtn">‚ûï ${i18n('addParam')}</button>
                        <button class="btn danger small delBtn">${i18n('del')}</button>
                    </td>
                    <td class="print-only"></td>`;
                stepRow.insertAdjacentHTML('beforeend', emptyCells);
                tbody.appendChild(stepRow);
            }
        });
    };

    const renderQc = () => {
        const container = $('#qcContainer');
        container.innerHTML = '';
        state.qualityControl.forEach(qcBlock => {
            const blockTpl = $('#qcBlockTpl').content.cloneNode(true);
            const blockEl = blockTpl.querySelector('.qc-block');
            blockEl.dataset.id = qcBlock.id;
            blockEl.querySelector('[data-key="name"]').value = qcBlock.name || '';
            blockEl.querySelector('[data-key="name"]').placeholder = i18n('qcBlockNamePlaceholder');
            blockEl.querySelector('.delQcBtn').textContent = i18n('delBlock');
            blockEl.querySelector('.addQcCheckBtn').textContent = `‚ûï ${i18n('addQcCheck')}`;
            
            blockEl.querySelector('[data-i18n="qcParamName"]').textContent = i18n('qcParamName');
            blockEl.querySelector('[data-i18n="qcStandard"]').textContent = i18n('qcStandard');
            blockEl.querySelector('[data-i18n="qcResult"]').textContent = i18n('qcResult');
            blockEl.querySelector('[data-i18n="actions"]').textContent = i18n('actions');

            const tbody = blockEl.querySelector('tbody');
            
            (qcBlock.checks || []).forEach(check => {
                const checkTpl = $('#qcCheckRowTpl').content.cloneNode(true);
                const checkRow = checkTpl.querySelector('tr');
                checkRow.dataset.id = qcBlock.id;
                checkRow.dataset.checkId = check.id;
                checkRow.querySelector('[data-key="parameter"]').value = check.parameter || '';
                checkRow.querySelector('[data-key="parameter"]').placeholder = i18n('qcParamPlaceholder');
                checkRow.querySelector('[data-key="standard"]').value = check.standard || '';
                checkRow.querySelector('[data-key="standard"]').placeholder = i18n('qcStandardPlaceholder');
                checkRow.querySelector('.delQcCheckBtn').textContent = 'X';
                tbody.appendChild(checkRow);
            });
            container.appendChild(blockEl);
        });
    };

    const renderAll = () => {
        renderIngredients();
        renderProcess();
        renderQc();
        $$('textarea').forEach(autoExpand);
    };

    // --- UTILITY FUNCTIONS ---
    const updateTotals = () => {
        const sum = state.ingredients.reduce((acc, ing) => acc + (parseFloat(ing.percent) || 0), 0);
        const sumEl = $('#sumPercent');
        sumEl.textContent = `${sum.toFixed(2)}%`;
        sumEl.className = Math.abs(sum - 100) < 0.01 ? 'ok' : 'bad';
    };

    // --- DATA HANDLERS ---
    const saveState = () => {
        $$('.card input, .card textarea').forEach(el => {
            const id = el.id;
            if (id && state.meta.hasOwnProperty(id)) {
                state.meta[id] = el.value;
            }
        });
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    };
    
    const debouncedSave = debounce(saveState, 400);

    const loadState = (data) => {
        state = data;
        Object.keys(state.meta).forEach(key => {
            const el = $(`#${key}`);
            if (el) el.value = state.meta[key];
        });
        renderAll();
    };

    const handleUpdate = (e) => {
        if (!e.target.classList.contains('data-field')) return;
        const key = e.target.dataset.key;
        const value = e.target.value;

        const ingRow = e.target.closest('tr[data-id]:not([data-param-id])');
        if (ingRow && $('#formBody').contains(ingRow)) {
            const item = state.ingredients.find(i => i.id == ingRow.dataset.id);
            if (item) {
                item[key] = value;
                if (e.target.tagName === 'TEXTAREA') {
                    e.target.nextElementSibling.textContent = value;
                }
                if (key === 'percent') {
                    const batchSize = parseFloat(state.meta.batchSize) || 0;
                    ingRow.querySelector('.mass-cell').textContent = (batchSize * (parseFloat(value) || 0) / 100).toFixed(3);
                    updateTotals();
                }
                if (key === 'phase') {
                    const activeEl = document.activeElement;
                    const rowId = activeEl.closest('tr')?.dataset.id;
                    const keyName = activeEl.dataset.key;
                    const selectionStart = activeEl.selectionStart;

                    state.ingredients.sort((a, b) => (a.phase || '').localeCompare(b.phase || ''));
                    renderIngredients();

                    if (rowId && keyName) {
                        const newEl = document.querySelector(`tr[data-id="${rowId}"] [data-key="${keyName}"]`);
                        if (newEl) {
                            newEl.focus();
                            newEl.setSelectionRange(selectionStart, selectionStart);
                        }
                    }
                }
            }
        }

        const procRow = e.target.closest('tr[data-id]');
        if (procRow && $('#procBody').contains(procRow)) {
            const step = state.processSteps.find(s => s.id == procRow.dataset.id);
            if (step) {
                const paramId = e.target.dataset.paramId;
                if (paramId) {
                    const param = step.parameters.find(p => p.id == paramId);
                    if (param) param[key] = value;
                } else {
                    step[key] = value;
                    if (e.target.tagName === 'TEXTAREA') {
                        e.target.nextElementSibling.textContent = value;
                    }
                }
            }
        }

        const qcBlock = e.target.closest('.qc-block[data-id]');
        if (qcBlock) {
            const block = state.qualityControl.find(b => b.id == qcBlock.dataset.id);
            if (block) {
                const checkRow = e.target.closest('tr[data-check-id]');
                if (checkRow) {
                    const check = block.checks.find(c => c.id == checkRow.dataset.checkId);
                    if (check) check[key] = value;
                } else {
                    block[key] = value;
                }
            }
        }
    };

    // --- EVENT LISTENERS ---
    function initialize() {
        $('#printBtn').addEventListener('click', () => window.print());
        $('#saveBtn').addEventListener('click', () => {
            saveState();
            const blob = new Blob([JSON.stringify(state, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `${state.meta.productCode || 'routemap'}_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            URL.revokeObjectURL(a.href);
        });
        $('#loadInput').addEventListener('change', (e) => {
            const file = e.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                try {
                    const loaded = JSON.parse(ev.target.result);
                    const validatedState = normalizeState(loaded);
                    loadState(validatedState); 
                    alert(i18n('dataLoaded'));
                } catch (err) { alert(i18n('fileReadError') + err.message); }
            };
            reader.readAsText(file); e.target.value = '';
        });
        
        $('#clearBtn').addEventListener('click', () => {
            if (confirm(i18n('confirmClear'))) {
                localStorage.removeItem(STORAGE_KEY);
                loadState(getInitialState());
            }
        });

        $('#langRuBtn').addEventListener('click', () => setLanguage('ru'));
        $('#langEnBtn').addEventListener('click', () => setLanguage('en'));

        $('#addIngredientBtn').addEventListener('click', () => {
            state.ingredients.push({ id: generateId(), phase: '', tradeName: '', percent: 0 });
            renderIngredients(); debouncedSave();
        });
        $('#addProcBtn').addEventListener('click', () => {
            state.processSteps.push({ id: generateId(), number: '', description: '', equipment: '', parameters: [] });
            renderProcess(); debouncedSave();
        });
        $('#addQcBtn').addEventListener('click', () => {
            state.qualityControl.push({ id: generateId(), name: '', checks: [] });
            renderQc(); debouncedSave();
        });

        document.body.addEventListener('click', (e) => {
            let needsSave = false;
            if (e.target.classList.contains('addParamBtn')) {
                const stepId = e.target.closest('tr').dataset.id;
                const step = state.processSteps.find(s => s.id == stepId);
                if (step) {
                    if (!step.parameters) step.parameters = [];
                    step.parameters.push({ id: generateId(), name: '', norm: '' });
                    renderProcess(); needsSave = true;
                }
            }
            if (e.target.classList.contains('addQcCheckBtn')) {
                const blockId = e.target.closest('.qc-block').dataset.id;
                const block = state.qualityControl.find(b => b.id == blockId);
                if (block) {
                    if (!block.checks) block.checks = [];
                    block.checks.push({ id: generateId(), parameter: '', standard: '' });
                    renderQc(); needsSave = true;
                }
            }
            if (e.target.classList.contains('delBtn')) {
                if (!confirm(i18n('confirmDelete'))) return;
                const ingRow = e.target.closest('tr[data-id]');
                if (ingRow && $('#formBody').contains(ingRow)) {
                    state.ingredients = state.ingredients.filter(i => i.id != ingRow.dataset.id);
                    renderIngredients(); needsSave = true;
                }
                const procRow = e.target.closest('tr[data-id]');
                if (procRow && $('#procBody').contains(procRow)) {
                    state.processSteps = state.processSteps.filter(s => s.id != procRow.dataset.id);
                    renderProcess(); needsSave = true;
                }
            }
            if (e.target.classList.contains('delParamBtn')) {
                const paramRow = e.target.closest('tr');
                const stepId = paramRow.dataset.id;
                const paramId = e.target.dataset.paramId;
                const step = state.processSteps.find(s => s.id == stepId);
                if (step) {
                    step.parameters = step.parameters.filter(p => p.id != paramId);
                    renderProcess(); needsSave = true;
                }
            }
            if (e.target.classList.contains('delQcBtn')) {
                if (!confirm(i18n('confirmDeleteBlock'))) return;
                const blockId = e.target.closest('.qc-block').dataset.id;
                state.qualityControl = state.qualityControl.filter(b => b.id != blockId);
                renderQc(); needsSave = true;
            }
            if (e.target.classList.contains('delQcCheckBtn')) {
                const checkRow = e.target.closest('tr');
                const blockId = checkRow.dataset.id;
                const checkId = checkRow.dataset.checkId;
                const block = state.qualityControl.find(b => b.id == blockId);
                if (block) {
                    block.checks = block.checks.filter(c => c.id != checkId);
                    renderQc(); needsSave = true;
                }
            }
            if (needsSave) debouncedSave();
        });

        document.body.addEventListener('input', (e) => {
            handleUpdate(e);
            if (e.target.tagName.toLowerCase() === 'textarea') {
                autoExpand(e.target);
            }
            debouncedSave();
        });
        $('#batchSize').addEventListener('input', (e) => {
            state.meta.batchSize = e.target.value;
            renderIngredients();
        });

        // Initial load
        const savedState = localStorage.getItem(STORAGE_KEY);
        if (savedState) {
            try { 
                loadState(normalizeState(JSON.parse(savedState))); 
            } 
            catch (e) { console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ localStorage:', e); }
        } else {
            $('#docDate').value = new Date().toISOString().slice(0,10);
        }
        setLanguage(currentLang);
    }

    initialize();
});
</script>
</body>
</html>