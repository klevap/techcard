<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="pageTitle">–ú–∞—Ä—à—Ä—É—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞ v4.1</title>
    <style>
        :root {
            --bg: #f4f7f9; --card: #ffffff; --ink: #2c3e50; --muted: #7f8c8d; --accent: #27ae60;
            --danger: #e74c3c; --warn: #f39c12; --line: #dfe4ea; --header-bg: #ecf0f1;
            --primary-btn-bg: #3498db; --primary-btn-border: #2980b9;
        }
        html, body { height: 100%; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg); color: var(--ink); margin: 0; line-height: 1.5; font-size: 14px;
        }
        .app { max-width: 1600px; margin: 24px auto; padding: 0 16px 64px; }
        h1 { font-size: 1.8rem; margin: 0 0 12px; color: #34495e; }
        h2 { font-size: 1.2rem; margin: 24px 0 12px; color: #34495e; border-bottom: 2px solid var(--header-bg); padding-bottom: 8px; }
        .toolbar { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; justify-content: space-between; margin-bottom: 16px; }
        .toolbar .left, .toolbar .right { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
        .card { background: var(--card); border: 1px solid var(--line); border-radius: 12px; padding: 16px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05); margin-bottom: 16px; }
        label { font-size: .9rem; color: var(--muted); font-weight: 600; margin-bottom: 4px; display: block; }
        input, select, textarea, button {
            background: #fff; color: var(--ink); border: 1px solid var(--line); border-radius: 8px; padding: 9px 12px; font-size: .95rem; width: 100%; box-sizing: border-box;
        }
        input:focus, select:focus, textarea:focus { outline: 2px solid #3498db; border-color: transparent; }
        textarea { resize: none; overflow-y: hidden; min-height: 40px; }
        .grid { display: grid; gap: 16px; }
        .meta-grid { grid-template-columns: repeat(6, 1fr); }
        .meta-grid .grid-span-full { grid-column: 1 / -1; }
        .meta-grid .grid-span-2 { grid-column: span 2; }
        .meta-grid .grid-span-3 { grid-column: span 3; }
        @media (max-width: 900px) { .meta-grid .grid-span-2, .meta-grid .grid-span-3 { grid-column: span 6; } }
        @media (max-width: 1200px) and (min-width: 901px) { .meta-grid .grid-span-3 { grid-column: span 6; } }

        .ok { color: var(--accent); } .bad { color: var(--danger); }
        .btn { cursor: pointer; transition: all .1s ease; user-select: none; border: none; color: #fff; width: auto; }
        .btn:hover { opacity: 0.9; } .btn:active { transform: scale(0.98); }
        .btn.primary { background: var(--primary-btn-bg); } .btn.secondary { background: #95a5a6; } .btn.danger { background: var(--danger); }
        .btn.small { padding: 5px 10px; font-size: .85rem; border-radius: 6px; }
        .lang-btn { background: #fff; color: var(--ink); padding: 6px 12px; font-size: 1.2rem; line-height: 1; }
        .lang-btn.active { outline: 2px solid var(--primary-btn-bg); box-shadow: 0 0 5px rgba(52, 152, 219, 0.5); }

        .row-actions { display: flex; gap: 6px; align-items: center; justify-content: center; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid var(--line); padding: 8px; vertical-align: top; text-align: left; }
        th { background: var(--header-bg); font-weight: 600; color: #34495e; white-space: nowrap; }
        .phase-header td { background: #3498db; color: white; font-weight: bold; }
        .step-header td { background: var(--header-bg); font-weight: bold; }
        .kpi { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
        .kpi .box { background: var(--header-bg); border: 1px solid var(--line); padding: 8px 12px; border-radius: 8px; }
        .spacer { flex: 1; }
        .section-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 12px; }
        .footnote { font-size: .85rem; color: var(--muted); text-align: center; margin-top: 20px; }
        input[type="number"] { text-align: right; }
        .text-center { text-align: center; }
        .print-only { display: none; }
        .fill-in { min-height: 1.3em; }
        .print-content { display: none; }
        
        /* Compact Print Options */
        .print-options-compact { display: flex; flex-wrap: wrap; align-items: center; gap: 20px; }
        .print-options-compact .option-group { display: flex; align-items: center; gap: 8px; }
        .print-options-compact label { margin: 0; font-weight: normal; color: var(--ink); white-space: nowrap; }
        .print-options-compact strong { font-weight: 600; color: var(--muted); }
        .print-options-compact select { width: auto; padding: 6px 10px; }
        .print-options-compact input[type="checkbox"] { width: auto; }

        @media print {
            body { background: #fff; color: #000; font-size: 10px; line-height: 1.3; }
            .app { max-width: 100%; margin: 0; padding: 10px; box-shadow: none; }
            .card { box-shadow: none; border: 1px solid #ccc; page-break-inside: avoid; padding: 10px; border-radius: 0; }
            .toolbar, .section-actions, .row-actions, .no-print { display: none !important; }
            h1, h2 { font-size: 1.2rem; color: #000; page-break-after: avoid; margin: 12px 0 8px; padding-bottom: 4px; border-color: #ccc; }
            h1 { font-size: 1.5rem; text-align: center; }
            textarea { display: none !important; }
            input, select { border: none; padding: 0; background: transparent; color: #000; -webkit-print-color-adjust: exact; width: 100%; font-size: inherit; font-family: inherit; box-shadow: none; outline: none; }
            .print-content { display: block !important; white-space: pre-wrap; word-break: break-word; font-family: inherit; font-size: inherit; }
            table { page-break-inside: auto; table-layout: fixed; }
            tr { page-break-inside: avoid; page-break-after: auto; }
            th, td { padding: 4px; border: 1px solid #aaa; vertical-align: middle; word-wrap: break-word; }
            th, .phase-header td { background-color: #e0e0e0 !important; color: #000 !important; -webkit-print-color-adjust: exact; }
            .print-only { display: table-cell !important; }
            .fill-in { border-bottom: none; }

            .card .meta-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0 16px; padding: 0; }
            .card .meta-grid > div { grid-column: auto !important; display: flex; align-items: baseline; border-bottom: 1px dotted #ccc; padding: 2px 0; }
            .card .meta-grid label { font-weight: 600; margin-right: 6px; padding: 0; color: #000; }
            .card .meta-grid label::after { content: ":"; }
            
            body.print-hide-description .description-card,
            body.print-hide-performance .performance-card,
            body.print-hide-stability .stability-card,
            body.print-hide-supplier .supplier-col,
            body.print-hide-notes .notes-col { display: none; }
            
            body.print-name-trade .inci-col,
            body.print-name-inci .trade-col { display: none; }

            /* Smart print override */
            body.print-force-hide-description .description-card,
            body.print-force-hide-performance .performance-card,
            body.print-force-hide-stability .stability-card {
                display: none !important;
            }
        }
    </style>
</head>
<body>
<div class="app">
    <!-- TOOLBAR -->
    <div class="toolbar card no-print">
        <div class="left"><h1 data-i18n="title">–ú–∞—Ä—à—Ä—É—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞</h1></div>
        <div class="right">
            <div class="lang-switcher" style="display: flex; gap: 5px;">
                <button class="btn lang-btn" id="langRuBtn" title="–†—É—Å—Å–∫–∏–π">üá∑üá∫</button>
                <button class="btn lang-btn" id="langEnBtn" title="English">üá¨üáß</button>
            </div>
            <button class="btn primary" id="printBtn" data-i18n="print">üñ®Ô∏è –ü–µ—á–∞—Ç—å / PDF</button>
            <button class="btn secondary" id="saveBtn" data-i18n="save">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å JSON</button>
            <label class="btn secondary" for="loadInput" data-i18n="load">üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç—å JSON</label>
            <input type="file" id="loadInput" class="no-print" accept=".json" style="display:none" />
            <button class="btn danger" id="clearBtn" data-i18n="clear">‚ùå –û—á–∏—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º—É</button>
        </div>
    </div>

    <!-- PRINT OPTIONS (COMPACT) -->
    <div class="card no-print">
        <div class="print-options-compact">
            <div class="option-group">
                <label for="printNameSelect" data-i18n="printNamePriority">–û—Å–Ω–æ–≤–Ω–æ–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ:</label>
                <select id="printNameSelect">
                    <option value="trade" data-i18n="printTradeName">–¢–æ—Ä–≥–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ</option>
                    <option value="inci" data-i18n="printInciName">INCI</option>
                </select>
            </div>
            <div class="option-group">
                <strong data-i18n="printShowBlocks">–ë–ª–æ–∫–∏:</strong>
                <input type="checkbox" id="printShowDescription" checked><label for="printShowDescription" data-i18n="printDescription">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                <input type="checkbox" id="printShowPerformance" checked><label for="printShowPerformance" data-i18n="printPerformance">–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</label>
                <input type="checkbox" id="printShowStability" checked><label for="printShowStability" data-i18n="printStability">–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å</label>
            </div>
            <div class="option-group">
                <strong data-i18n="printShowColumns">–ö–æ–ª–æ–Ω–∫–∏:</strong>
                <input type="checkbox" id="printShowSupplier" checked><label for="printShowSupplier" data-i18n="printSupplier">–ü–æ—Å—Ç–∞–≤—â–∏–∫</label>
                <input type="checkbox" id="printShowNotes" checked><label for="printShowNotes" data-i18n="printNotes">–ü—Ä–∏–º–µ—á–∞–Ω–∏—è</label>
            </div>
        </div>
    </div>

    <!-- META INFO -->
    <div class="card">
        <h2 data-i18n="meta">–ö–∞—Ä—Ç–æ—á–∫–∞ –∏–∑–¥–µ–ª–∏—è</h2>
        <div class="grid meta-grid">
            <div class="grid-span-3"><label data-i18n="productName">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞</label><input id="productName" /></div>
            <div class="grid-span-2"><label data-i18n="productCode">–ö–æ–¥ / –ê—Ä—Ç–∏–∫—É–ª</label><input id="productCode" /></div>
            <div><label data-i18n="version">–í–µ—Ä—Å–∏—è</label><input id="docVersion" value="1.0" /></div>
            <div class="grid-span-3"><label data-i18n="author">–¢–µ—Ö–Ω–æ–ª–æ–≥</label><input id="author" /></div>
            <div class="grid-span-2"><label data-i18n="date">–î–∞—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞</label><input id="docDate" type="date" /></div>
            <div><label data-i18n="batchSize">–†–∞–∑–º–µ—Ä –ø–∞—Ä—Ç–∏–∏ (–∫–≥)</label><input id="batchSize" type="number" min="0" step="0.01" value="100" /></div>
            <div class="grid-span-full description-card">
                <label data-i18n="description">–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞</label>
                <textarea id="description" rows="2"></textarea>
                <div class="print-content" id="description-print"></div>
            </div>
        </div>
    </div>

    <!-- FORMULATION TABLE -->
    <div class="card">
        <div class="kpi">
            <h2 data-i18n="formulation">–†–µ—Ü–µ–ø—Ç—É—Ä–∞</h2>
            <span class="spacer"></span>
            <div class="box"><span class="muted" data-i18n="totalPercent">–°—É–º–º–∞ %:</span> <strong id="sumPercent">0.00%</strong></div>
        </div>
        <table id="formTable">
            <thead><tr>
                <th style="width:5%" data-i18n="phase">–§–∞–∑–∞</th>
                <th class="trade-col" style="width:25%" data-i18n="tradeName">–¢–æ—Ä–≥. –Ω–∞–∑–≤–∞–Ω–∏–µ</th>
                <th class="inci-col" style="width:25%" data-i18n="inciName">INCI</th>
                <th class="supplier-col" style="width:10%" data-i18n="supplier">–ü–æ—Å—Ç–∞–≤—â–∏–∫</th>
                <th class="notes-col" style="width:10%" data-i18n="notes">–ü—Ä–∏–º–µ—á–∞–Ω–∏—è</th>
                <th style="width:6%" data-i18n="percent">%</th>
                <th style="width:8%" data-i18n="mass">–ó–∞–≥—Ä—É–∑–∫–∞, –∫–≥</th>
                <th style="width:11%" class="no-print" data-i18n="actions">–î–µ–π—Å—Ç–≤–∏—è</th>
                <th class="print-only" data-i18n="actualMass">–§–∞–∫—Ç, –∫–≥</th>
            </tr></thead>
            <tbody id="formBody"></tbody>
        </table>
        <div class="section-actions no-print"><button class="btn primary small" id="addIngredientBtn" data-i18n="addIngredient">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç</button></div>
    </div>

    <!-- PERFORMANCE DATA -->
    <div class="card performance-card">
        <h2 data-i18n="performance">–î–∞–Ω–Ω—ã–µ –æ–± —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</h2>
        <table id="perfTable">
            <thead><tr>
                <th style="width:40%" data-i18n="perfParam">–ü–∞—Ä–∞–º–µ—Ç—Ä</th>
                <th style="width:40%" data-i18n="perfValue">–ó–Ω–∞—á–µ–Ω–∏–µ</th>
                <th style="width:20%" class="no-print" data-i18n="actions">–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr></thead>
            <tbody id="perfBody"></tbody>
        </table>
        <div class="section-actions no-print"><button class="btn primary small" id="addPerfBtn" data-i18n="addPerf">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä</button></div>
    </div>

    <!-- STABILITY DATA -->
    <div class="card stability-card">
        <h2 data-i18n="stability">–î–∞–Ω–Ω—ã–µ –æ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏</h2>
        <table id="stabTable">
            <thead><tr>
                <th style="width:40%" data-i18n="stabCondition">–£—Å–ª–æ–≤–∏–µ</th>
                <th style="width:40%" data-i18n="stabResult">–†–µ–∑—É–ª—å—Ç–∞—Ç</th>
                <th style="width:20%" class="no-print" data-i18n="actions">–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr></thead>
            <tbody id="stabBody"></tbody>
        </table>
        <div class="section-actions no-print"><button class="btn primary small" id="addStabBtn" data-i18n="addStab">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç</button></div>
    </div>

    <!-- PROCESS TABLE -->
    <div class="card">
        <h2 data-i18n="process">–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø—Ä–æ—Ü–µ—Å—Å</h2>
        <table id="procTable">
            <thead><tr>
                <th style="width:5%" data-i18n="step">‚Ññ</th>
                <th style="width:30%" data-i18n="opDescription">–û–ø–∏—Å–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏</th>
                <th style="width:20%" data-i18n="equipment">–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</th>
                <th style="width:20%" data-i18n="paramName">–ü–∞—Ä–∞–º–µ—Ç—Ä –ø—Ä–æ—Ü–µ—Å—Å–∞</th>
                <th style="width:10%" data-i18n="norm">–ù–æ—Ä–º–∞</th>
                <th style="width:15%" class="no-print" data-i18n="actions">–î–µ–π—Å—Ç–≤–∏—è</th>
                <th class="print-only" data-i18n="actual">–§–∞–∫—Ç</th>
            </tr></thead>
            <tbody id="procBody"></tbody>
        </table>
        <div class="section-actions no-print"><button class="btn primary small" id="addProcBtn" data-i18n="addStep">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å—Ç–∞–¥–∏—é</button></div>
    </div>

    <!-- QC TABLE -->
    <div class="card">
        <h2 data-i18n="qc">–ö–æ–Ω—Ç—Ä–æ–ª—å –∫–∞—á–µ—Å—Ç–≤–∞ (–û–ö–ö)</h2>
        <div id="qcContainer"></div>
        <div class="section-actions no-print"><button class="btn primary small" id="addQcBtn" data-i18n="addQc">‚ûï –î–æ–±–∞–≤–∏—Ç—å –±–ª–æ–∫ –∫–æ–Ω—Ç—Ä–æ–ª—è</button></div>
    </div>
    
    <div class="footnote no-print"><span data-i18n="foot">–ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ.</span></div>
</div>

<!-- TEMPLATES -->
<template id="ingredientRowTpl">
    <tr>
        <td><input class="data-field text-center" data-key="phase" maxlength="5"></td>
        <td class="trade-col">
            <textarea class="data-field" data-key="tradeName" rows="1"></textarea>
            <div class="print-content" data-key="tradeName-print"></div>
        </td>
        <td class="inci-col">
            <textarea class="data-field" data-key="inciName" rows="1"></textarea>
            <div class="print-content" data-key="inciName-print"></div>
        </td>
        <td class="supplier-col"><input class="data-field" data-key="supplier"></td>
        <td class="notes-col"><input class="data-field" data-key="notes"></td>
        <td><input class="data-field text-center" data-key="percent" type="number" min="0" max="100" step="0.01" value="0"></td>
        <td class="mass-cell" style="text-align: right;">0.000</td>
        <td class="no-print row-actions"><button class="btn danger small delBtn" data-i18n="del">–£–¥–∞–ª–∏—Ç—å</button></td>
        <td class="print-only"><div class="fill-in"></div></td>
    </tr>
</template>

<template id="perfRowTpl">
    <tr>
        <td><input class="data-field" data-key="parameter"></td>
        <td><input class="data-field" data-key="value"></td>
        <td class="no-print row-actions"><button class="btn danger small delBtn" data-i18n="del">–£–¥–∞–ª–∏—Ç—å</button></td>
    </tr>
</template>

<template id="stabRowTpl">
    <tr>
        <td><input class="data-field" data-key="condition"></td>
        <td><input class="data-field" data-key="result"></td>
        <td class="no-print row-actions"><button class="btn danger small delBtn" data-i18n="del">–£–¥–∞–ª–∏—Ç—å</button></td>
    </tr>
</template>

<template id="procStepRowTpl">
    <tr class="step-header">
        <td class="step-number" style="text-align: center; vertical-align: middle;"></td>
        <td class="step-description" style="vertical-align: middle;">
            <textarea class="data-field" data-key="description" rows="2"></textarea>
            <div class="print-content" data-key="description-print"></div>
        </td>
        <td class="step-equipment" style="vertical-align: middle;">
            <textarea class="data-field" data-key="equipment" rows="2"></textarea>
            <div class="print-content" data-key="equipment-print"></div>
        </td>
    </tr>
</template>

<template id="procParamRowTpl">
    <tr class="param-row">
        <td><input class="data-field" data-key="name"></td>
        <td><input class="data-field" data-key="norm"></td>
        <td class="no-print row-actions"><button class="btn danger small delParamBtn" data-i18n="del">X</button></td>
        <td class="print-only"><div class="fill-in"></div></td>
    </tr>
</template>

<template id="qcBlockTpl">
    <div class="qc-block" style="margin-bottom: 20px;">
        <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
            <input class="data-field" data-key="name" style="font-weight:bold; font-size:1.1rem; border:none; border-bottom:1px solid #ccc; flex:1;">
            <button class="btn danger small delQcBtn no-print" data-i18n="delBlock">–£–¥–∞–ª–∏—Ç—å –±–ª–æ–∫</button>
        </div>
        <table>
            <thead><tr>
                <th data-i18n="qcParamName">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è</th>
                <th data-i18n="qcStandard">–ù–æ—Ä–º–∞—Ç–∏–≤</th>
                <th data-i18n="qcResult">–†–µ–∑—É–ª—å—Ç–∞—Ç</th>
                <th class="no-print" data-i18n="actions">–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr></thead>
            <tbody></tbody>
        </table>
        <div class="section-actions no-print">
            <button class="btn primary small addQcCheckBtn" data-i18n="addQcCheck">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É</button>
        </div>
    </div>
</template>

<template id="qcCheckRowTpl">
    <tr>
        <td><input class="data-field" data-key="parameter"></td>
        <td><input class="data-field" data-key="standard"></td>
        <td><div class="fill-in"></div></td>
        <td class="no-print row-actions"><button class="btn danger small delQcCheckBtn" data-i18n="del">X</button></td>
    </tr>
</template>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    const STORAGE_KEY = "routing_map_draft_v4.1";
    const LANG_KEY = "routing_map_lang";

    // --- I18N - INTERNATIONALIZATION ---
    const translations = {
        ru: {
            pageTitle: "–ú–∞—Ä—à—Ä—É—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞ v4.1",
            title: "–ú–∞—Ä—à—Ä—É—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞",
            print: "üñ®Ô∏è –ü–µ—á–∞—Ç—å / PDF", save: "üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å JSON", load: "üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç—å JSON", clear: "‚ùå –û—á–∏—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º—É",
            printNamePriority: "–û—Å–Ω–æ–≤–Ω–æ–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ:",
            printTradeName: "–¢–æ—Ä–≥–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ", printInciName: "INCI",
            printShowBlocks: "–ë–ª–æ–∫–∏:", printDescription: "–û–ø–∏—Å–∞–Ω–∏–µ", printPerformance: "–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å", printStability: "–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å",
            printShowColumns: "–ö–æ–ª–æ–Ω–∫–∏:", printSupplier: "–ü–æ—Å—Ç–∞–≤—â–∏–∫", printNotes: "–ü—Ä–∏–º–µ—á–∞–Ω–∏—è",
            meta: "–ö–∞—Ä—Ç–æ—á–∫–∞ –∏–∑–¥–µ–ª–∏—è",
            productName: "–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞", productCode: "–ö–æ–¥ / –ê—Ä—Ç–∏–∫—É–ª", version: "–í–µ—Ä—Å–∏—è", date: "–î–∞—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞", author: "–¢–µ—Ö–Ω–æ–ª–æ–≥", batchSize: "–†–∞–∑–º–µ—Ä –ø–∞—Ä—Ç–∏–∏ (–∫–≥)", description: "–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞",
            formulation: "–†–µ—Ü–µ–ø—Ç—É—Ä–∞", totalPercent: "–°—É–º–º–∞ %:",
            phase: "–§–∞–∑–∞", tradeName: "–¢–æ—Ä–≥. –Ω–∞–∑–≤–∞–Ω–∏–µ", inciName: "INCI", supplier: "–ü–æ—Å—Ç–∞–≤—â–∏–∫", notes: "–ü—Ä–∏–º–µ—á–∞–Ω–∏—è", percent: "%", mass: "–ó–∞–≥—Ä—É–∑–∫–∞, –∫–≥", actions: "–î–µ–π—Å—Ç–≤–∏—è", actualMass: "–§–∞–∫—Ç, –∫–≥",
            addIngredient: "‚ûï –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç",
            performance: "–î–∞–Ω–Ω—ã–µ –æ–± —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏", perfParam: "–ü–∞—Ä–∞–º–µ—Ç—Ä", perfValue: "–ó–Ω–∞—á–µ–Ω–∏–µ", addPerf: "‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä",
            stability: "–î–∞–Ω–Ω—ã–µ –æ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏", stabCondition: "–£—Å–ª–æ–≤–∏–µ", stabResult: "–†–µ–∑—É–ª—å—Ç–∞—Ç", addStab: "‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç",
            process: "–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø—Ä–æ—Ü–µ—Å—Å", step: "‚Ññ", opDescription: "–û–ø–∏—Å–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏", equipment: "–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ", paramName: "–ü–∞—Ä–∞–º–µ—Ç—Ä –ø—Ä–æ—Ü–µ—Å—Å–∞", norm: "–ù–æ—Ä–º–∞", actual: "–§–∞–∫—Ç",
            addStep: "‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å—Ç–∞–¥–∏—é",
            qc: "–ö–æ–Ω—Ç—Ä–æ–ª—å –∫–∞—á–µ—Å—Ç–≤–∞ (–û–ö–ö)", addQc: "‚ûï –î–æ–±–∞–≤–∏—Ç—å –±–ª–æ–∫ –∫–æ–Ω—Ç—Ä–æ–ª—è",
            foot: "–ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ.",
            del: "–£–¥–∞–ª–∏—Ç—å", delBlock: "–£–¥–∞–ª–∏—Ç—å –±–ª–æ–∫", addParam: "‚ûï –ü–∞—Ä–∞–º–µ—Ç—Ä", addQcCheck: "‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É",
            phaseHeader: "–§–∞–∑–∞",
            dataLoaded: "–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã!", fileReadError: "–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞: ",
            confirmDelete: "–í—ã —É–≤–µ—Ä–µ–Ω—ã?", confirmClear: "–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º—É? –í—Å–µ –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã.", confirmDeleteBlock: "–£–¥–∞–ª–∏—Ç—å –≤–µ—Å—å –±–ª–æ–∫ –∫–æ–Ω—Ç—Ä–æ–ª—è?",
            qcParamName: "–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è", qcStandard: "–ù–æ—Ä–º–∞—Ç–∏–≤", qcResult: "–†–µ–∑—É–ª—å—Ç–∞—Ç",
        },
        en: {
            pageTitle: "Technical Specification v4.1",
            title: "Technical Specification",
            print: "üñ®Ô∏è Print / PDF", save: "üíæ Save JSON", load: "üìÅ Load JSON", clear: "‚ùå Clear Form",
            printNamePriority: "Primary Name:",
            printTradeName: "Trade Name", printInciName: "INCI",
            printShowBlocks: "Blocks:", printDescription: "Description", printPerformance: "Performance", printStability: "Stability",
            printShowColumns: "Columns:", printSupplier: "Supplier", printNotes: "Notes",
            meta: "Product Information",
            productName: "Product Name", productCode: "Code / SKU", version: "Version", date: "Document Date", author: "Technologist", batchSize: "Batch Size (kg)", description: "Product Description",
            formulation: "Formulation", totalPercent: "Total %:",
            phase: "Phase", tradeName: "Trade Name", inciName: "INCI", supplier: "Supplier", notes: "Notes", percent: "%", mass: "Load, kg", actions: "Actions", actualMass: "Actual, kg",
            addIngredient: "‚ûï Add Ingredient",
            performance: "Performance Data", perfParam: "Parameter", perfValue: "Value", addPerf: "‚ûï Add Parameter",
            stability: "Stability Data", stabCondition: "Condition", stabResult: "Result", addStab: "‚ûï Add Test",
            process: "Technological Process", step: "#", opDescription: "Operation Description", equipment: "Equipment", paramName: "Process Parameter", norm: "Standard", actual: "Actual",
            addStep: "‚ûï Add Step",
            qc: "Quality Control (QC)", addQc: "‚ûï Add QC Block",
            foot: "Autosave is enabled.",
            del: "Delete", delBlock: "Delete block", addParam: "‚ûï Parameter", addQcCheck: "‚ûï Add Check",
            phaseHeader: "Phase",
            dataLoaded: "Data loaded successfully!", fileReadError: "File read error: ",
            confirmDelete: "Are you sure?", confirmClear: "Are you sure you want to clear the entire form? All unsaved data will be lost.", confirmDeleteBlock: "Delete the entire control block?",
            qcParamName: "Parameter Name", qcStandard: "Standard", qcResult: "Result",
        }
    };
    let currentLang = localStorage.getItem(LANG_KEY) || 'ru';

    const i18n = (key) => translations[currentLang][key] || key;

    const setLanguage = (lang) => {
        currentLang = lang;
        localStorage.setItem(LANG_KEY, lang);
        document.documentElement.lang = lang;
        
        $('#langRuBtn').classList.toggle('active', lang === 'ru');
        $('#langEnBtn').classList.toggle('active', lang === 'en');

        $$('[data-i18n]').forEach(el => {
            const key = el.dataset.i18n;
            if (el.tagName === 'OPTION') {
                el.label = i18n(key);
            } else {
                el.textContent = i18n(key);
            }
        });
        renderAll();
    };

    // --- HELPER FUNCTIONS ---
    const generateId = () => `id_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    const debounce = (func, wait) => {
        let timeout;
        return function executedFunction(...args) {
            const later = () => { clearTimeout(timeout); func.apply(this, args); };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    };
    
    const autoExpand = (textarea) => {
        textarea.style.height = 'auto';
        textarea.style.height = textarea.scrollHeight + 'px';
    };

    const getInitialState = () => ({
        meta: { productName: '', productCode: '', docVersion: '1.0', docDate: new Date().toISOString().slice(0,10), author: '', batchSize: 100, description: '' },
        ingredients: [],
        performanceData: [],
        stabilityData: [],
        processSteps: [],
        qualityControl: []
    });

    function normalizeState(data) {
        const defaults = getInitialState();
        const normalized = {
            meta: { ...defaults.meta, ...(data.meta || {}) },
            ingredients: Array.isArray(data.ingredients) ? data.ingredients : defaults.ingredients,
            performanceData: Array.isArray(data.performanceData) ? data.performanceData : defaults.performanceData,
            stabilityData: Array.isArray(data.stabilityData) ? data.stabilityData : defaults.stabilityData,
            processSteps: Array.isArray(data.processSteps) ? data.processSteps : defaults.processSteps,
            qualityControl: Array.isArray(data.qualityControl) ? data.qualityControl : defaults.qualityControl
        };
        // Backward compatibility for old 'name' field
        normalized.ingredients.forEach(ing => {
            if (ing.name && !ing.tradeName) {
                ing.tradeName = ing.name;
                delete ing.name;
            }
        });
        return normalized;
    }

    let state = getInitialState();

    // --- RENDER FUNCTIONS ---
    const renderSimpleTable = (tbodyId, data, templateId, keys) => {
        const tbody = $(tbodyId);
        tbody.innerHTML = '';
        data.forEach(item => {
            const tpl = $(templateId).content.cloneNode(true);
            const row = tpl.querySelector('tr');
            row.dataset.id = item.id;
            keys.forEach(key => {
                row.querySelector(`[data-key="${key}"]`).value = item[key] || '';
            });
            row.querySelector('.delBtn').textContent = i18n('del');
            tbody.appendChild(row);
        });
    };

    const renderIngredients = () => {
        const tbody = $('#formBody');
        tbody.innerHTML = '';
        const batchSize = parseFloat(state.meta.batchSize) || 0;
        
        let lastPhase = null;
        state.ingredients.forEach(ing => {
            const currentPhase = (ing.phase || '').toUpperCase();
            if (currentPhase && currentPhase !== lastPhase) {
                const tr = document.createElement('tr');
                tr.className = 'phase-header';
                const td = document.createElement('td');
                td.colSpan = 9;
                td.textContent = `${i18n('phaseHeader')} ${currentPhase}`;
                tr.appendChild(td);
                tbody.appendChild(tr);
                lastPhase = currentPhase;
            }

            const tpl = $('#ingredientRowTpl').content.cloneNode(true);
            const row = tpl.querySelector('tr');
            row.dataset.id = ing.id;
            ['phase', 'tradeName', 'inciName', 'supplier', 'notes', 'percent'].forEach(key => {
                const el = row.querySelector(`[data-key="${key}"]`);
                if (el) el.value = ing[key] || '';
                if (el && el.tagName === 'TEXTAREA') {
                    row.querySelector(`[data-key="${key}-print"]`).textContent = ing[key] || '';
                }
            });
            row.querySelector('.mass-cell').textContent = (batchSize * (parseFloat(ing.percent) || 0) / 100).toFixed(3);
            row.querySelector('.delBtn').textContent = i18n('del');
            tbody.appendChild(row);
        });
        updateTotals();
    };

    const renderProcess = () => {
        const tbody = $('#procBody');
        tbody.innerHTML = '';
        state.processSteps.forEach(step => {
            const numParams = step.parameters?.length || 0;
            const rowspan = numParams > 0 ? numParams : 1;

            const stepTpl = $('#procStepRowTpl').content.cloneNode(true);
            const stepRow = stepTpl.querySelector('tr');
            stepRow.dataset.id = step.id;

            const numberCell = stepRow.querySelector('.step-number');
            numberCell.setAttribute('rowspan', rowspan);
            const input = document.createElement('input');
            input.className = 'data-field text-center';
            input.dataset.key = 'number';
            input.style.fontWeight = 'bold';
            input.value = step.number || '';
            numberCell.appendChild(input);

            ['description', 'equipment'].forEach(key => {
                const cell = stepRow.querySelector(`.step-${key}`);
                cell.querySelector(`[data-key="${key}"]`).value = step[key] || '';
                cell.querySelector(`[data-key="${key}-print"]`).textContent = step[key] || '';
                cell.setAttribute('rowspan', rowspan);
            });

            if (numParams > 0) {
                const firstParam = step.parameters[0];
                const paramTpl = $('#procParamRowTpl').content.cloneNode(true);
                const paramCells = Array.from(paramTpl.querySelector('tr').children);
                paramCells[0].querySelector('input').value = firstParam.name || '';
                paramCells[0].querySelector('input').dataset.paramId = firstParam.id;
                paramCells[1].querySelector('input').value = firstParam.norm || '';
                paramCells[1].querySelector('input').dataset.paramId = firstParam.id;
                paramCells[2].querySelector('button').dataset.paramId = firstParam.id;
                paramCells[2].querySelector('button').textContent = 'X';
                
                const actionsTd = paramCells[2]; 
                actionsTd.style.whiteSpace = 'nowrap';

                const addBtn = document.createElement('button');
                addBtn.className = 'btn primary small addParamBtn';
                addBtn.textContent = `‚ûï ${i18n('addParam')}`;
                actionsTd.appendChild(addBtn);

                const delStepBtn = document.createElement('button');
                delStepBtn.className = 'btn danger small delBtn';
                delStepBtn.textContent = i18n('del');
                actionsTd.appendChild(delStepBtn);

                stepRow.append(...paramCells);
                tbody.appendChild(stepRow);

                for (let i = 1; i < numParams; i++) {
                    const param = step.parameters[i];
                    const subsequentParamTpl = $('#procParamRowTpl').content.cloneNode(true);
                    const subsequentParamRow = subsequentParamTpl.querySelector('tr');
                    subsequentParamRow.dataset.id = step.id;
                    subsequentParamRow.querySelector('[data-key="name"]').value = param.name || '';
                    subsequentParamRow.querySelector('[data-key="name"]').dataset.paramId = param.id;
                    subsequentParamRow.querySelector('[data-key="norm"]').value = param.norm || '';
                    subsequentParamRow.querySelector('[data-key="norm"]').dataset.paramId = param.id;
                    const delParamBtn = subsequentParamRow.querySelector('.delParamBtn');
                    delParamBtn.dataset.paramId = param.id;
                    delParamBtn.textContent = 'X';
                    tbody.appendChild(subsequentParamRow);
                }
            } else {
                const emptyCells = `
                    <td></td><td></td>
                    <td class="no-print row-actions">
                        <button class="btn primary small addParamBtn">‚ûï ${i18n('addParam')}</button>
                        <button class="btn danger small delBtn">${i18n('del')}</button>
                    </td>
                    <td class="print-only"></td>`;
                stepRow.insertAdjacentHTML('beforeend', emptyCells);
                tbody.appendChild(stepRow);
            }
        });
    };

    const renderQc = () => {
        const container = $('#qcContainer');
        container.innerHTML = '';
        state.qualityControl.forEach(qcBlock => {
            const blockTpl = $('#qcBlockTpl').content.cloneNode(true);
            const blockEl = blockTpl.querySelector('.qc-block');
            blockEl.dataset.id = qcBlock.id;
            blockEl.querySelector('[data-key="name"]').value = qcBlock.name || '';
            blockEl.querySelector('.delQcBtn').textContent = i18n('delBlock');
            blockEl.querySelector('.addQcCheckBtn').textContent = `‚ûï ${i18n('addQcCheck')}`;
            
            ['qcParamName', 'qcStandard', 'qcResult', 'actions'].forEach(key => {
                const th = blockEl.querySelector(`[data-i18n="${key}"]`);
                if (th) th.textContent = i18n(key);
            });

            const tbody = blockEl.querySelector('tbody');
            
            (qcBlock.checks || []).forEach(check => {
                const checkTpl = $('#qcCheckRowTpl').content.cloneNode(true);
                const checkRow = checkTpl.querySelector('tr');
                checkRow.dataset.id = qcBlock.id;
                checkRow.dataset.checkId = check.id;
                checkRow.querySelector('[data-key="parameter"]').value = check.parameter || '';
                checkRow.querySelector('[data-key="standard"]').value = check.standard || '';
                checkRow.querySelector('.delQcCheckBtn').textContent = 'X';
                tbody.appendChild(checkRow);
            });
            container.appendChild(blockEl);
        });
    };

    const renderAll = () => {
        renderIngredients();
        renderSimpleTable('#perfBody', state.performanceData, '#perfRowTpl', ['parameter', 'value']);
        renderSimpleTable('#stabBody', state.stabilityData, '#stabRowTpl', ['condition', 'result']);
        renderProcess();
        renderQc();
        $$('textarea').forEach(autoExpand);
    };

    // --- UTILITY FUNCTIONS ---
    const updateTotals = () => {
        const sum = state.ingredients.reduce((acc, ing) => acc + (parseFloat(ing.percent) || 0), 0);
        const sumEl = $('#sumPercent');
        sumEl.textContent = `${sum.toFixed(2)}%`;
        sumEl.className = Math.abs(sum - 100) < 0.01 ? 'ok' : 'bad';
    };

    // --- DATA HANDLERS ---
    const saveState = () => {
        $$('.card input, .card textarea').forEach(el => {
            const id = el.id;
            if (id && state.meta.hasOwnProperty(id)) {
                state.meta[id] = el.value;
            }
        });
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    };
    
    const debouncedSave = debounce(saveState, 400);

    const loadState = (data) => {
        state = data;
        Object.keys(state.meta).forEach(key => {
            const el = $(`#${key}`);
            if (el) el.value = state.meta[key];
        });
        $('#description-print').textContent = state.meta.description || '';
        renderAll();
    };

    const handleUpdate = (e) => {
        if (!e.target.classList.contains('data-field')) return;
        const key = e.target.dataset.key;
        const value = e.target.value;

        const findAndSet = (collection, row, key, value) => {
            const item = collection.find(i => i.id == row.dataset.id);
            if (item) item[key] = value;
        };

        const ingRow = e.target.closest('#formBody tr[data-id]');
        if (ingRow) {
            const item = state.ingredients.find(i => i.id == ingRow.dataset.id);
            if (item) {
                item[key] = value;
                if (e.target.tagName === 'TEXTAREA') {
                    e.target.nextElementSibling.textContent = value;
                }
                if (key === 'percent') {
                    const batchSize = parseFloat(state.meta.batchSize) || 0;
                    ingRow.querySelector('.mass-cell').textContent = (batchSize * (parseFloat(value) || 0) / 100).toFixed(3);
                    updateTotals();
                }
                if (key === 'phase') {
                    const activeEl = document.activeElement;
                    const rowId = activeEl.closest('tr')?.dataset.id;
                    const keyName = activeEl.dataset.key;
                    const selectionStart = activeEl.selectionStart;

                    state.ingredients.sort((a, b) => (a.phase || '').localeCompare(b.phase || ''));
                    renderIngredients();

                    if (rowId && keyName) {
                        const newEl = document.querySelector(`tr[data-id="${rowId}"] [data-key="${keyName}"]`);
                        if (newEl) {
                            newEl.focus();
                            newEl.setSelectionRange(selectionStart, selectionStart);
                        }
                    }
                }
            }
        }
        
        const perfRow = e.target.closest('#perfBody tr[data-id]');
        if (perfRow) findAndSet(state.performanceData, perfRow, key, value);

        const stabRow = e.target.closest('#stabBody tr[data-id]');
        if (stabRow) findAndSet(state.stabilityData, stabRow, key, value);

        const procRow = e.target.closest('#procBody tr[data-id]');
        if (procRow) {
            const step = state.processSteps.find(s => s.id == procRow.dataset.id);
            if (step) {
                const paramId = e.target.dataset.paramId;
                if (paramId) {
                    const param = step.parameters.find(p => p.id == paramId);
                    if (param) param[key] = value;
                } else {
                    step[key] = value;
                    if (e.target.tagName === 'TEXTAREA') {
                        e.target.nextElementSibling.textContent = value;
                    }
                }
            }
        }

        const qcBlock = e.target.closest('.qc-block[data-id]');
        if (qcBlock) {
            const block = state.qualityControl.find(b => b.id == qcBlock.dataset.id);
            if (block) {
                const checkRow = e.target.closest('tr[data-check-id]');
                if (checkRow) {
                    const check = block.checks.find(c => c.id == checkRow.dataset.checkId);
                    if (check) check[key] = value;
                } else {
                    block[key] = value;
                }
            }
        }
    };

    // --- EVENT LISTENERS ---
    function initialize() {
        $('#printBtn').addEventListener('click', () => {
            // Smart print logic: add override classes if data is empty
            document.body.classList.toggle('print-force-hide-description', !state.meta.description?.trim());
            document.body.classList.toggle('print-force-hide-performance', state.performanceData.length === 0);
            document.body.classList.toggle('print-force-hide-stability', state.stabilityData.length === 0);

            window.print();

            // Clean up override classes after printing
            setTimeout(() => {
                document.body.classList.remove(
                    'print-force-hide-description', 
                    'print-force-hide-performance', 
                    'print-force-hide-stability'
                );
            }, 100);
        });

        $('#saveBtn').addEventListener('click', () => {
            saveState();
            const blob = new Blob([JSON.stringify(state, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `${state.meta.productCode || 'techspec'}_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            URL.revokeObjectURL(a.href);
        });
        $('#loadInput').addEventListener('change', (e) => {
            const file = e.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                try {
                    const loaded = JSON.parse(ev.target.result);
                    const validatedState = normalizeState(loaded);
                    loadState(validatedState); 
                    alert(i18n('dataLoaded'));
                } catch (err) { alert(i18n('fileReadError') + err.message); }
            };
            reader.readAsText(file); e.target.value = '';
        });
        
        $('#clearBtn').addEventListener('click', () => {
            if (confirm(i18n('confirmClear'))) {
                localStorage.removeItem(STORAGE_KEY);
                loadState(getInitialState());
            }
        });

        $('#langRuBtn').addEventListener('click', () => setLanguage('ru'));
        $('#langEnBtn').addEventListener('click', () => setLanguage('en'));

        $('#addIngredientBtn').addEventListener('click', () => {
            state.ingredients.push({ id: generateId(), phase: '', tradeName: '', inciName: '', supplier: '', notes: '', percent: 0 });
            renderIngredients(); debouncedSave();
        });
        $('#addPerfBtn').addEventListener('click', () => {
            state.performanceData.push({ id: generateId(), parameter: '', value: '' });
            renderSimpleTable('#perfBody', state.performanceData, '#perfRowTpl', ['parameter', 'value']);
            debouncedSave();
        });
        $('#addStabBtn').addEventListener('click', () => {
            state.stabilityData.push({ id: generateId(), condition: '', result: '' });
            renderSimpleTable('#stabBody', state.stabilityData, '#stabRowTpl', ['condition', 'result']);
            debouncedSave();
        });
        $('#addProcBtn').addEventListener('click', () => {
            state.processSteps.push({ id: generateId(), number: '', description: '', equipment: '', parameters: [] });
            renderProcess(); debouncedSave();
        });
        $('#addQcBtn').addEventListener('click', () => {
            state.qualityControl.push({ id: generateId(), name: '', checks: [] });
            renderQc(); debouncedSave();
        });

        document.body.addEventListener('click', (e) => {
            let needsSave = false;
            if (e.target.classList.contains('addParamBtn')) {
                const stepId = e.target.closest('tr').dataset.id;
                const step = state.processSteps.find(s => s.id == stepId);
                if (step) {
                    if (!step.parameters) step.parameters = [];
                    step.parameters.push({ id: generateId(), name: '', norm: '' });
                    renderProcess(); needsSave = true;
                }
            }
            if (e.target.classList.contains('addQcCheckBtn')) {
                const blockId = e.target.closest('.qc-block').dataset.id;
                const block = state.qualityControl.find(b => b.id == blockId);
                if (block) {
                    if (!block.checks) block.checks = [];
                    block.checks.push({ id: generateId(), parameter: '', standard: '' });
                    renderQc(); needsSave = true;
                }
            }
            if (e.target.classList.contains('delBtn')) {
                if (!confirm(i18n('confirmDelete'))) return;
                const row = e.target.closest('tr[data-id]');
                if (!row) return;
                const id = row.dataset.id;
                if ($('#formBody').contains(row)) { state.ingredients = state.ingredients.filter(i => i.id != id); renderIngredients(); needsSave = true; }
                if ($('#perfBody').contains(row)) { state.performanceData = state.performanceData.filter(i => i.id != id); renderSimpleTable('#perfBody', state.performanceData, '#perfRowTpl', ['parameter', 'value']); needsSave = true; }
                if ($('#stabBody').contains(row)) { state.stabilityData = state.stabilityData.filter(i => i.id != id); renderSimpleTable('#stabBody', state.stabilityData, '#stabRowTpl', ['condition', 'result']); needsSave = true; }
                if ($('#procBody').contains(row)) { state.processSteps = state.processSteps.filter(s => s.id != id); renderProcess(); needsSave = true; }
            }
            if (e.target.classList.contains('delParamBtn')) {
                const paramRow = e.target.closest('tr');
                const stepId = paramRow.dataset.id;
                const paramId = e.target.dataset.paramId;
                const step = state.processSteps.find(s => s.id == stepId);
                if (step) {
                    step.parameters = step.parameters.filter(p => p.id != paramId);
                    renderProcess(); needsSave = true;
                }
            }
            if (e.target.classList.contains('delQcBtn')) {
                if (!confirm(i18n('confirmDeleteBlock'))) return;
                const blockId = e.target.closest('.qc-block').dataset.id;
                state.qualityControl = state.qualityControl.filter(b => b.id != blockId);
                renderQc(); needsSave = true;
            }
            if (e.target.classList.contains('delQcCheckBtn')) {
                const checkRow = e.target.closest('tr');
                const blockId = checkRow.dataset.id;
                const checkId = checkRow.dataset.checkId;
                const block = state.qualityControl.find(b => b.id == blockId);
                if (block) {
                    block.checks = block.checks.filter(c => c.id != checkId);
                    renderQc(); needsSave = true;
                }
            }
            if (needsSave) debouncedSave();
        });

        document.body.addEventListener('input', (e) => {
            handleUpdate(e);
            if (e.target.tagName.toLowerCase() === 'textarea') {
                autoExpand(e.target);
                if (e.target.id === 'description') {
                    $('#description-print').textContent = e.target.value;
                }
            }
            debouncedSave();
        });
        $('#batchSize').addEventListener('input', (e) => {
            state.meta.batchSize = e.target.value;
            renderIngredients();
        });

        // Print options listeners
        const updatePrintClasses = () => {
            document.body.classList.toggle('print-hide-description', !$('#printShowDescription').checked);
            document.body.classList.toggle('print-hide-performance', !$('#printShowPerformance').checked);
            document.body.classList.toggle('print-hide-stability', !$('#printShowStability').checked);
            document.body.classList.toggle('print-hide-supplier', !$('#printShowSupplier').checked);
            document.body.classList.toggle('print-hide-notes', !$('#printShowNotes').checked);
            
            const namePriority = $('#printNameSelect').value;
            document.body.classList.toggle('print-name-trade', namePriority === 'trade');
            document.body.classList.toggle('print-name-inci', namePriority === 'inci');
        };
        $$('.print-options-compact input, .print-options-compact select').forEach(el => el.addEventListener('change', updatePrintClasses));

        // Initial load
        const savedState = localStorage.getItem(STORAGE_KEY);
        if (savedState) {
            try { 
                loadState(normalizeState(JSON.parse(savedState))); 
            } 
            catch (e) { console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ localStorage:', e); }
        } else {
            $('#docDate').value = new Date().toISOString().slice(0,10);
        }
        setLanguage(currentLang);
        updatePrintClasses();
    }

    initialize();
});
</script>
</body>
</html>