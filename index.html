<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="pageTitle">–†–µ—Ü–µ–ø—Ç—É—Ä–∞ –∏ –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∞—è –∫–∞—Ä—Ç–∞ PRO v2.3</title>
    <style>
        :root {
            --bg: #f4f7f9; --card: #ffffff; --ink: #2c3e50; --muted: #7f8c8d; --accent: #27ae60;
            --danger: #e74c3c; --warn: #f39c12; --line: #dfe4ea; --header-bg: #ecf0f1;
            --primary-btn-bg: #3498db; --primary-btn-border: #2980b9;
        }
        html, body { height: 100%; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg); color: var(--ink); margin: 0; line-height: 1.5;
        }
        .app { max-width: 1400px; margin: 24px auto; padding: 0 16px 64px; }
        h1 { font-size: 1.8rem; margin: 0 0 12px; color: #34495e; }
        h2 { font-size: 1.2rem; margin: 24px 0 12px; color: #34495e; border-bottom: 2px solid var(--header-bg); padding-bottom: 8px; }
        .toolbar { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; justify-content: space-between; margin-bottom: 16px; }
        .toolbar .left, .toolbar .right { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
        .card { background: var(--card); border: 1px solid var(--line); border-radius: 12px; padding: 16px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05); margin-bottom: 16px; }
        label { font-size: .9rem; color: var(--muted); font-weight: 600; margin-bottom: 4px; display: block; }
        input, select, textarea, button {
            background: #fff; color: var(--ink); border: 1px solid var(--line); border-radius: 8px; padding: 9px 12px; font-size: .95rem; width: 100%; box-sizing: border-box;
        }
        input:focus, select:focus, textarea:focus { outline: 2px solid #3498db; border-color: transparent; }
        input::placeholder, textarea::placeholder { color: #bdc3c7; }
        textarea { resize: vertical; min-height: 60px; }
        .grid { display: grid; gap: 16px; }
        .grid.cols-4 { grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
        .ok { color: var(--accent); } .warn { color: var(--warn); } .bad { color: var(--danger); }
        .btn { cursor: pointer; transition: all .1s ease; user-select: none; border: none; color: #fff; width: auto; }
        .btn:hover { opacity: 0.9; }
        .btn:active { transform: scale(0.98); }
        .btn.primary { background: var(--primary-btn-bg); }
        .btn.secondary { background: #95a5a6; }
        .btn.danger { background: var(--danger); }
        .btn.small { padding: 5px 10px; font-size: .85rem; border-radius: 6px; }
        .row-actions { display: flex; gap: 6px; align-items: center; justify-content: center; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border-bottom: 1px solid var(--line); padding: 10px; vertical-align: top; text-align: left; }
        th { background: var(--header-bg); font-weight: 600; color: #34495e; white-space: nowrap; }
        tr:last-child td { border-bottom: none; }
        .phase-header td { background: #3498db; color: white; font-weight: bold; border-bottom: 2px solid #2980b9; }
        .total-row td { background: var(--header-bg); font-weight: bold; }
        .kpi { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
        .kpi .box { background: var(--header-bg); border: 1px solid var(--line); padding: 8px 12px; border-radius: 8px; }
        .spacer { flex: 1; }
        .section-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 12px; }
        .footnote { font-size: .85rem; color: var(--muted); text-align: center; margin-top: 20px; }
        input[type="number"] { text-align: right; }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è "–∑–µ—Ä–∫–∞–ª–∞ –ø–µ—á–∞—Ç–∏" - –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–∫—Ä—ã—Ç–æ */
        .print-content {
            display: none;
        }

        @media print {
            body {
                background: #fff;
                color: #000;
            }
            /* –£–±–∏—Ä–∞–µ–º –æ—Ç—Å—Ç—É–ø—ã –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
            .app {
                max-width: 100%;
                margin: 0;
                padding: 0;
                box-shadow: none;
            }
            .card {
                box-shadow: none;
                border: 1px solid #ccc;
                page-break-inside: avoid;
                padding: 10px; /* –ù–µ–±–æ–ª—å—à–æ–π –æ—Ç—Å—Ç—É–ø –≤–Ω—É—Ç—Ä–∏ –∫–∞—Ä—Ç–æ—á–µ–∫ */
            }
            .toolbar, .section-actions, .row-actions, .no-print {
                display: none !important;
            }
            input, select {
                border: none;
                padding: 2px;
                background: transparent;
                color: #000;
                -webkit-print-color-adjust: exact;
                width: 100%;
            }
            h1, h2 {
                color: #000;
                page-break-after: avoid;
            }
            th, .phase-header td, .total-row td {
                background-color: #eee !important;
                color: #000 !important;
                -webkit-print-color-adjust: exact;
            }
            table {
                page-break-inside: auto;
            }
            tr {
                page-break-inside: avoid;
                page-break-after: auto;
            }

            /* –ö–ª—é—á–µ–≤–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ: —Å–∫—Ä—ã–≤–∞–µ–º textarea –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º div —Å –ø–æ–ª–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º */
            textarea {
                display: none !important;
            }
            .print-content {
                display: block !important;
                white-space: pre-wrap; /* –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫ –∏ –ø—Ä–æ–±–µ–ª—ã */
                word-break: break-word; /* –ü–µ—Ä–µ–Ω–æ—Å–∏—Ç –¥–ª–∏–Ω–Ω—ã–µ —Å–ª–æ–≤–∞ */
                font-family: inherit;
                font-size: inherit;
            }
        }
    </style>
</head>
<body>
<div class="app">
    <!-- TOOLBAR -->
    <div class="toolbar card">
        <div class="left"><h1 data-i18n="title">–†–µ—Ü–µ–ø—Ç—É—Ä–∞ –∏ –¢–µ—Ö. –ö–∞—Ä—Ç–∞</h1></div>
        <div class="right">
            <select id="langSel" aria-label="Language"><option value="ru" selected>–†—É—Å—Å–∫–∏–π</option><option value="en">English</option></select>
            <button class="btn primary" id="printBtn" data-i18n="print">üñ®Ô∏è –ü–µ—á–∞—Ç—å / PDF</button>
            <button class="btn secondary" id="saveBtn" data-i18n="save">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å JSON</button>
            <label class="btn secondary" for="loadInput" data-i18n="load">üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç—å JSON</label>
            <input type="file" id="loadInput" class="no-print" accept=".json" style="display:none" />
        </div>
    </div>

    <!-- META INFO -->
    <div class="card">
        <h2 data-i18n="meta">–ö–∞—Ä—Ç–æ—á–∫–∞ –∏–∑–¥–µ–ª–∏—è</h2>
        <div class="grid cols-4">
            <div><label data-i18n="productName">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞</label><input id="productName" /></div>
            <div><label data-i18n="productCode">–ö–æ–¥ / –ê—Ä—Ç–∏–∫—É–ª</label><input id="productCode" /></div>
            <div><label data-i18n="version">–í–µ—Ä—Å–∏—è</label><input id="docVersion" value="1.0" /></div>
            <div><label data-i18n="date">–î–∞—Ç–∞</label><input id="docDate" type="date" /></div>
            <div><label data-i18n="author">–¢–µ—Ö–Ω–æ–ª–æ–≥</label><input id="author" /></div>
            <div><label data-i18n="batchSize">–†–∞–∑–º–µ—Ä –ø–∞—Ä—Ç–∏–∏ (–∫–≥)</label><input id="batchSize" type="number" min="0" step="0.01" value="100" /></div>
        </div>
    </div>

    <!-- FORMULATION TABLE -->
    <div class="card">
        <div class="kpi">
            <h2 data-i18n="formulation">–†–µ—Ü–µ–ø—Ç—É—Ä–∞</h2>
            <span class="spacer"></span>
            <div class="box"><span class="muted" data-i18n="totalPercent">–°—É–º–º–∞ %:</span> <strong id="sumPercent">0.00%</strong></div>
        </div>
        <table id="formTable">
            <thead><tr><th style="width:5%" data-i18n="phase">–§–∞–∑–∞</th><th style="width:30%" data-i18n="inci">INCI</th><th style="width:30%" data-i18n="trade">–¢–æ—Ä–≥–æ–≤–æ–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th><th style="width:8%" data-i18n="percent">% (w/w)</th><th style="width:10%" data-i18n="mass">–ú–∞—Å—Å–∞ (–∫–≥)</th><th style="width:17%" class="no-print" data-i18n="actions">–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
            <tbody id="formBody"></tbody>
        </table>
        <div class="section-actions no-print"><button class="btn primary small" id="addIngredientBtn" data-i18n="addIngredient">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç</button></div>
    </div>

    <!-- PROCESS TABLE -->
    <div class="card">
        <h2 data-i18n="process">–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ —Å—Ç–∞–¥–∏–∏</h2>
        <table id="procTable">
            <thead><tr><th style="width:5%" data-i18n="step">–®–∞–≥</th><th style="width:35%" data-i18n="description">–û–ø–∏—Å–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏</th><th style="width:25%" data-i18n="equipment">–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –∏ —Ä–µ–∂–∏–º</th><th style="width:10%" data-i18n="temp">–¢–µ–º–ø. ¬∞C</th><th style="width:10%" data-i18n="time">–í—Ä–µ–º—è –º–∏–Ω</th><th style="width:15%" class="no-print" data-i18n="actions">–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
            <tbody id="procBody"></tbody>
        </table>
        <div class="section-actions no-print"><button class="btn primary small" id="addProcBtn" data-i18n="addStep">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å—Ç–∞–¥–∏—é</button></div>
    </div>
    
    <div class="footnote"><span data-i18n="foot">–ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ. –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –≤ PDF —á–µ—Ä–µ–∑ –ø–µ—á–∞—Ç—å –±—Ä–∞—É–∑–µ—Ä–∞.</span></div>
</div>

<!-- DATALIST & TEMPLATES -->
<datalist id="phaseList"><option value="A">A - –í–æ–¥–Ω–∞—è —Ñ–∞–∑–∞</option><option value="B">B - –ú–∞—Å–ª—è–Ω–∞—è —Ñ–∞–∑–∞</option><option value="C">C - –ê–∫—Ç–∏–≤—ã/–û—Ö–ª–∞–∂–¥–µ–Ω–∏–µ</option><option value="D">D</option><option value="E">E</option></datalist>

<template id="ingredientRowTpl">
    <tr>
        <td><input class="data-field" data-key="phase" list="phaseList" placeholder="A" maxlength="3"></td>
        <td><input class="data-field" data-key="inci" placeholder="Aqua, Glycerin..."></td>
        <td><input class="data-field" data-key="tradeName" placeholder="Purified Water"></td>
        <td><input class="data-field" data-key="percent" type="number" min="0" max="100" step="0.01" value="0"></td>
        <td class="mass-cell" style="text-align: right;">0.000</td>
        <td class="no-print row-actions"><button class="btn secondary small upBtn" title="–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤–≤–µ—Ä—Ö">‚Üë</button><button class="btn secondary small downBtn" title="–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤–Ω–∏–∑">‚Üì</button><button class="btn danger small delBtn" data-i18n="del">–£–¥–∞–ª–∏—Ç—å</button></td>
    </tr>
</template>

<template id="procRowTpl">
    <tr>
        <td class="step-cell" style="text-align: center; font-weight: bold;"></td>
        <td>
            <textarea class="data-field" data-key="description" placeholder="–ù–∞–≥—Ä–µ—Ç—å —Ñ–∞–∑—É –ê –¥–æ 75¬∞C..." rows="2"></textarea>
            <div class="print-content" data-key="description-print"></div>
        </td>
        <td>
            <textarea class="data-field" data-key="equipment" placeholder="–†–µ–∞–∫—Ç–æ—Ä –†–ú–ì-100. –ú–µ—à–∞–ª–∫–∞: 50 rpm" rows="2"></textarea>
            <div class="print-content" data-key="equipment-print"></div>
        </td>
        <td><input class="data-field" data-key="temp" type="text" placeholder="75-80"></td>
        <td><input class="data-field" data-key="time" type="text" placeholder="15-20"></td>
        <td class="no-print row-actions"><button class="btn secondary small upBtn" title="–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤–≤–µ—Ä—Ö">‚Üë</button><button class="btn secondary small downBtn" title="–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤–Ω–∏–∑">‚Üì</button><button class="btn danger small delBtn" data-i18n="del">–£–¥–∞–ª–∏—Ç—å</button></td>
    </tr>
</template>

<script>
// --- INTERNATIONALIZATION DATA ---
const I18N = {
    ru: {
        pageTitle: "–†–µ—Ü–µ–ø—Ç—É—Ä–∞ –∏ –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∞—è –∫–∞—Ä—Ç–∞ PRO v2.3", title: "–†–µ—Ü–µ–ø—Ç—É—Ä–∞ –∏ –¢–µ—Ö. –ö–∞—Ä—Ç–∞", print: "üñ®Ô∏è –ü–µ—á–∞—Ç—å / PDF", save: "üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å JSON", load: "üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç—å JSON",
        meta: "–ö–∞—Ä—Ç–æ—á–∫–∞ –∏–∑–¥–µ–ª–∏—è", productName: "–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞", productCode: "–ö–æ–¥ / –ê—Ä—Ç–∏–∫—É–ª", version: "–í–µ—Ä—Å–∏—è", date: "–î–∞—Ç–∞", author: "–¢–µ—Ö–Ω–æ–ª–æ–≥", batchSize: "–†–∞–∑–º–µ—Ä –ø–∞—Ä—Ç–∏–∏ (–∫–≥)",
        formulation: "–†–µ—Ü–µ–ø—Ç—É—Ä–∞", totalPercent: "–°—É–º–º–∞ %:", phase: "–§–∞–∑–∞", inci: "INCI", trade: "–¢–æ—Ä–≥–æ–≤–æ–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ", percent: "% (w/w)", mass: "–ú–∞—Å—Å–∞ (–∫–≥)", actions: "–î–µ–π—Å—Ç–≤–∏—è", addIngredient: "‚ûï –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç",
        process: "–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ —Å—Ç–∞–¥–∏–∏", step: "–®–∞–≥", description: "–û–ø–∏—Å–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏", equipment: "–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –∏ —Ä–µ–∂–∏–º", temp: "–¢–µ–º–ø. ¬∞C", time: "–í—Ä–µ–º—è –º–∏–Ω", addStep: "‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å—Ç–∞–¥–∏—é",
        del: "–£–¥–∞–ª–∏—Ç—å", foot: "–ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ. –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –≤ PDF —á–µ—Ä–µ–∑ –ø–µ—á–∞—Ç—å –±—Ä–∞—É–∑–µ—Ä–∞.",
        phaseA: "–§–ê–ó–ê A - –í–æ–¥–Ω–∞—è", phaseB: "–§–ê–ó–ê B - –ú–∞—Å–ª—è–Ω–∞—è", phaseC: "–§–ê–ó–ê C - –ê–∫—Ç–∏–≤—ã/–û—Ö–ª–∞–∂–¥–µ–Ω–∏–µ", phaseD: "–§–ê–ó–ê D", phaseE: "–§–ê–ó–ê E", total: "–ò–¢–û–ì–û"
    },
    en: {
        pageTitle: "Formulation & Tech Card PRO v2.3", title: "Formulation & Tech Card", print: "üñ®Ô∏è Print / PDF", save: "üíæ Save JSON", load: "üìÅ Load JSON",
        meta: "Product Master Data", productName: "Product Name", productCode: "Code / SKU", version: "Version", date: "Date", author: "Technologist", batchSize: "Batch Size (kg)",
        formulation: "Formulation", totalPercent: "Total %:", phase: "Phase", inci: "INCI", trade: "Trade Name", percent: "% (w/w)", mass: "Mass (kg)", actions: "Actions", addIngredient: "‚ûï Add Ingredient",
        process: "Process Steps", step: "Step", description: "Operation Description", equipment: "Equipment & Mode", temp: "Temp ¬∞C", time: "Time min", addStep: "‚ûï Add Step",
        del: "Delete", foot: "Autosave is enabled. Export to PDF via browser print.",
        phaseA: "PHASE A - Water", phaseB: "PHASE B - Oil", phaseC: "PHASE C - Actives/Cooldown", phaseD: "PHASE D", phaseE: "PHASE E", total: "TOTAL"
    }
};

document.addEventListener('DOMContentLoaded', () => {
    // --- DOM & STATE SETUP ---
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    const STORAGE_KEY = "formulation_pro_draft_v2.3";

    let state = {
        meta: { productName: '', productCode: '', docVersion: '1.0', docDate: '', author: '', batchSize: 100 },
        ingredients: [],
        processSteps: []
    };

    // --- RENDER FUNCTIONS (Update UI from state) ---
    const renderIngredients = () => {
        const tbody = $('#formBody');
        const focusedId = document.activeElement?.closest('tr')?.dataset.id;
        const focusedKey = document.activeElement?.dataset.key;

        tbody.innerHTML = '';
        const batchSize = parseFloat(state.meta.batchSize) || 0;
        const lang = $('#langSel').value;

        const grouped = state.ingredients.reduce((acc, ing) => {
            const phase = (ing.phase || '...').toUpperCase();
            if (!acc[phase]) acc[phase] = [];
            acc[phase].push(ing);
            return acc;
        }, {});

        const phaseOrder = ['A', 'B', 'C', 'D', 'E'];
        const sortedPhases = Object.keys(grouped).sort((a, b) => {
            const indexA = phaseOrder.indexOf(a); const indexB = phaseOrder.indexOf(b);
            if (indexA !== -1 && indexB !== -1) return indexA - indexB;
            if (indexA !== -1) return -1; if (indexB !== -1) return 1;
            return a.localeCompare(b);
        });

        for (const phase of sortedPhases) {
            const phaseHeader = `<tr class="phase-header"><td colspan="6">${I18N[lang][`phase${phase}`] || `PHASE ${phase}`}</td></tr>`;
            tbody.insertAdjacentHTML('beforeend', phaseHeader);

            grouped[phase].forEach(ing => {
                const tpl = $('#ingredientRowTpl').content.cloneNode(true);
                const row = tpl.querySelector('tr');
                row.dataset.id = ing.id;
                row.querySelector('[data-key="phase"]').value = ing.phase || '';
                row.querySelector('[data-key="inci"]').value = ing.inci || '';
                row.querySelector('[data-key="tradeName"]').value = ing.tradeName || '';
                row.querySelector('[data-key="percent"]').value = ing.percent || 0;
                row.querySelector('.mass-cell').textContent = (batchSize * (parseFloat(ing.percent) || 0) / 100).toFixed(3);
                tbody.appendChild(row);
            });
        }
        updateTotals();
        restoreFocus(focusedId, focusedKey);
    };

    const renderProcess = () => {
        const tbody = $('#procBody');
        const focusedId = document.activeElement?.closest('tr')?.dataset.id;
        const focusedKey = document.activeElement?.dataset.key;

        tbody.innerHTML = '';
        state.processSteps.forEach((step, index) => {
            const tpl = $('#procRowTpl').content.cloneNode(true);
            const row = tpl.querySelector('tr');
            row.dataset.id = step.id;
            row.querySelector('.step-cell').textContent = index + 1;
            
            // Populate both textarea and its print mirror
            const descTextarea = row.querySelector('[data-key="description"]');
            const descPrintDiv = row.querySelector('[data-key="description-print"]');
            descTextarea.value = step.description || '';
            descPrintDiv.textContent = step.description || '';

            const equipTextarea = row.querySelector('[data-key="equipment"]');
            const equipPrintDiv = row.querySelector('[data-key="equipment-print"]');
            equipTextarea.value = step.equipment || '';
            equipPrintDiv.textContent = step.equipment || '';

            row.querySelector('[data-key="temp"]').value = step.temp || '';
            row.querySelector('[data-key="time"]').value = step.time || '';
            tbody.appendChild(row);
        });
        restoreFocus(focusedId, focusedKey);
    };

    const renderAll = () => {
        renderIngredients();
        renderProcess();
    };

    // --- UTILITY FUNCTIONS ---
    const updateTotals = () => {
        const sum = state.ingredients.reduce((acc, ing) => acc + (parseFloat(ing.percent) || 0), 0);
        const sumEl = $('#sumPercent');
        sumEl.textContent = `${sum.toFixed(2)}%`;
        sumEl.className = Math.abs(sum - 100) < 0.01 ? 'ok' : 'bad';
    };

    const setLanguage = (lang) => {
        document.documentElement.lang = lang;
        $$("[data-i18n]").forEach(el => {
            const key = el.getAttribute("data-i18n");
            if (I18N[lang][key]) el.textContent = I18N[lang][key];
        });
        renderAll();
    };

    const restoreFocus = (id, key) => {
        if (!id || !key) return;
        setTimeout(() => {
            const newElement = $(`tr[data-id="${id}"] [data-key="${key}"]`);
            if (newElement) {
                newElement.focus();
                if (newElement.select && newElement.type !== 'textarea') newElement.select();
            }
        }, 0);
    };

    // --- DATA HANDLERS (Modify state) ---
    const handleGenericAdd = (type, defaultData) => {
        state[type].push({ ...defaultData, id: Date.now() });
        if (type === 'ingredients') renderIngredients();
        if (type === 'processSteps') renderProcess();
        saveState();
    };

    const handleGenericUpdate = (e, type) => {
        if (!e.target.classList.contains('data-field')) return;
        const row = e.target.closest('tr');
        const id = parseInt(row.dataset.id);
        const key = e.target.dataset.key;
        const value = e.target.value;
        
        const item = state[type].find(i => i.id === id);
        if (item) {
            item[key] = value;
            // Sync textarea content to its print mirror in real-time
            if (e.target.tagName === 'TEXTAREA') {
                const printMirror = e.target.nextElementSibling;
                if (printMirror) {
                    printMirror.textContent = value;
                }
            }
            if (type === 'ingredients' && key === 'percent') {
                const batchSize = parseFloat(state.meta.batchSize) || 0;
                row.querySelector('.mass-cell').textContent = (batchSize * (parseFloat(value) || 0) / 100).toFixed(3);
                updateTotals();
            }
            if (type === 'ingredients' && key === 'phase') {
                setTimeout(() => renderIngredients(), 500);
            }
        }
    };

    const handleGenericActions = (e, type) => {
        const row = e.target.closest('tr');
        if (!row) return;
        const id = parseInt(row.dataset.id);
        const index = state[type].findIndex(i => i.id === id);

        if (e.target.classList.contains('delBtn')) {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É —Å—Ç—Ä–æ–∫—É?')) state[type].splice(index, 1);
            else return;
        }
        if (e.target.classList.contains('upBtn') && index > 0) {
            [state[type][index], state[type][index - 1]] = [state[type][index - 1], state[type][index]];
        }
        if (e.target.classList.contains('downBtn') && index < state[type].length - 1) {
            [state[type][index], state[type][index + 1]] = [state[type][index + 1], state[type][index]];
        }
        
        if (type === 'ingredients') renderIngredients();
        if (type === 'processSteps') renderProcess();
        saveState();
    };

    // --- STORAGE & FILE HANDLERS ---
    const saveState = () => {
        state.meta.productName = $('#productName').value;
        state.meta.productCode = $('#productCode').value;
        state.meta.docVersion = $('#docVersion').value;
        state.meta.docDate = $('#docDate').value;
        state.meta.author = $('#author').value;
        state.meta.batchSize = $('#batchSize').value;
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    };

    const loadState = (data) => {
        state = data;
        $('#productName').value = state.meta.productName || '';
        $('#productCode').value = state.meta.productCode || '';
        $('#docVersion').value = state.meta.docVersion || '1.0';
        $('#docDate').value = state.meta.docDate || '';
        $('#author').value = state.meta.author || '';
        $('#batchSize').value = state.meta.batchSize || 100;
        renderAll();
    };

    const handleSaveFile = () => {
        saveState();
        const dateStr = new Date().toISOString().split('T')[0];
        const safeName = (state.meta.productCode || state.meta.productName || 'formulation').replace(/[^a-z0-9–∞-—è—ë\-_]/gi, '_');
        const filename = `${safeName}_${dateStr}.json`;
        
        const blob = new Blob([JSON.stringify(state, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = filename; a.click(); URL.revokeObjectURL(url);
    };

    const handleLoadFile = (e) => {
        const file = e.target.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
            try {
                const loaded = JSON.parse(ev.target.result);
                if (loaded.meta && Array.isArray(loaded.ingredients) && Array.isArray(loaded.processSteps)) {
                    loadState(loaded); alert('–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã!');
                } else { throw new Error("–ù–µ–≤–µ—Ä–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–∞"); }
            } catch (err) { alert('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞: ' + err.message); }
        };
        reader.readAsText(file); e.target.value = '';
    };

    // --- INITIALIZATION ---
    function initialize() {
        $('#langSel').addEventListener('change', (e) => setLanguage(e.target.value));
        $('#printBtn').addEventListener('click', () => window.print());
        $('#saveBtn').addEventListener('click', handleSaveFile);
        $('#loadInput').addEventListener('change', handleLoadFile);

        $('#addIngredientBtn').addEventListener('click', () => handleGenericAdd('ingredients', { phase: 'A', inci: '', tradeName: '', percent: 0 }));
        $('#addProcBtn').addEventListener('click', () => handleGenericAdd('processSteps', { description: '', equipment: '', temp: '', time: '' }));
        
        $('#formBody').addEventListener('input', (e) => handleGenericUpdate(e, 'ingredients'));
        $('#procBody').addEventListener('input', (e) => handleGenericUpdate(e, 'processSteps'));
        $('#formBody').addEventListener('click', (e) => handleGenericActions(e, 'ingredients'));
        $('#procBody').addEventListener('click', (e) => handleGenericActions(e, 'processSteps'));

        ['#productName', '#productCode', '#docVersion', '#docDate', '#author'].forEach(id => $(id).addEventListener('input', saveState));
        $('#batchSize').addEventListener('input', () => { saveState(); renderIngredients(); });

        const savedState = localStorage.getItem(STORAGE_KEY);
        if (savedState) {
            try { loadState(JSON.parse(savedState)); } 
            catch (e) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ localStorage:', e);
                $('#docDate').valueAsDate = new Date(); state.meta.docDate = $('#docDate').value; renderAll();
            }
        } else {
            $('#docDate').valueAsDate = new Date(); state.meta.docDate = $('#docDate').value; renderAll();
        }
        
        setLanguage($('#langSel').value);
    }

    initialize();
});
</script>
</body>
</html>